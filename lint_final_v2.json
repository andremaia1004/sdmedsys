[{"filePath":"E:\\SDMED Sys\\app\\(dashboard)\\SidebarNav.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\app\\(dashboard)\\admin\\audit\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\app\\(dashboard)\\admin\\doctors\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":124,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":124,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { useState, useEffect } from 'react';\r\nimport { Card } from '@/components/ui/Card';\r\nimport { Table } from '@/components/ui/Table';\r\nimport { Button } from '@/components/ui/Button';\r\nimport { Input } from '@/components/ui/Input';\r\nimport { Badge } from '@/components/ui/Badge';\r\nimport { fetchDoctorsAction, createDoctorAction, updateDoctorAction } from '@/app/actions/admin';\r\nimport { Doctor } from '@/features/doctors/types';\r\nimport { UserPlus, UserMinus, ShieldCheck, Mail, Phone, Hash, Award, Eye, EyeOff } from 'lucide-react';\r\n\r\nexport default function DoctorsAdminPage() {\r\n    const [doctors, setDoctors] = useState<Doctor[]>([]);\r\n    const [loading, setLoading] = useState(true);\r\n    const [isSaving, setIsSaving] = useState(false);\r\n    const [showForm, setShowForm] = useState(false);\r\n    const [showPassword, setShowPassword] = useState(false);\r\n\r\n    // Form Stats\r\n    const [name, setName] = useState('');\r\n    const [specialty, setSpecialty] = useState('');\r\n    const [crm, setCrm] = useState('');\r\n    const [phone, setPhone] = useState('');\r\n    const [email, setEmail] = useState('');\r\n    const [password, setPassword] = useState('');\r\n    const [createAuth, setCreateAuth] = useState(true);\r\n\r\n    useEffect(() => {\r\n        loadDoctors();\r\n    }, []);\r\n\r\n    const loadDoctors = async () => {\r\n        setLoading(true);\r\n        try {\r\n            const data = await fetchDoctorsAction(false);\r\n            setDoctors(data);\r\n        } catch (err) {\r\n            console.error(err);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    const [isEditing, setIsEditing] = useState(false);\r\n    const [editingId, setEditingId] = useState<string | null>(null);\r\n\r\n    // ... (existing useEffect) ...\r\n\r\n    const handleSubmit = async (e: React.FormEvent) => {\r\n        e.preventDefault();\r\n        setIsSaving(true);\r\n        try {\r\n            const formData = new FormData();\r\n            formData.append('name', name);\r\n            formData.append('specialty', specialty);\r\n            formData.append('crm', crm);\r\n            formData.append('phone', phone);\r\n            formData.append('email', email);\r\n            if (password) formData.append('password', password);\r\n            formData.append('createAuth', createAuth.toString());\r\n\r\n            let res;\r\n            if (isEditing && editingId) {\r\n                res = await updateDoctorAction(editingId, {\r\n                    name,\r\n                    specialty,\r\n                    crm,\r\n                    phone,\r\n                    email,\r\n                    password: password || undefined\r\n                });\r\n            } else {\r\n                res = await createDoctorAction(formData);\r\n            }\r\n\r\n            if (res.success) {\r\n                resetForm();\r\n                await loadDoctors();\r\n            } else {\r\n                alert(res.error || 'Erro ao processar (sem detalhes)');\r\n            }\r\n        } catch (err: unknown) {\r\n            console.error(err);\r\n            const msg = err instanceof Error ? err.message : 'Unknown error';\r\n            alert(msg || 'Erro inesperado na comunicação com o servidor');\r\n        } finally {\r\n            setIsSaving(false);\r\n        }\r\n    };\r\n\r\n    const resetForm = () => {\r\n        setName('');\r\n        setSpecialty('');\r\n        setCrm('');\r\n        setPhone('');\r\n        setEmail('');\r\n        setPassword('');\r\n        setIsEditing(false);\r\n        setEditingId(null);\r\n        setShowForm(false);\r\n        setCreateAuth(true);\r\n    };\r\n\r\n    const handleEdit = (doctor: Doctor) => {\r\n        setName(doctor.name);\r\n        setSpecialty(doctor.specialty || '');\r\n        setCrm(doctor.crm || '');\r\n        setPhone(doctor.phone || '');\r\n        setEmail(doctor.email || '');\r\n        setPassword(''); // Always blank for security, user enters only if changing\r\n        setCreateAuth(!!doctor.profileId);\r\n\r\n        setIsEditing(true);\r\n        setEditingId(doctor.id);\r\n        setShowForm(true);\r\n        window.scrollTo({ top: 0, behavior: 'smooth' });\r\n    };\r\n\r\n    const toggleActive = async (doctor: Doctor) => {\r\n        try {\r\n            await updateDoctorAction(doctor.id, { active: !doctor.active });\r\n            await loadDoctors();\r\n        } catch (err) {\r\n            alert('Erro ao atualizar status');\r\n        }\r\n    };\r\n\r\n    const generatePassword = () => {\r\n        const charset = \"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*\";\r\n        let retVal = \"\";\r\n        for (let i = 0, n = charset.length; i < 12; ++i) {\r\n            retVal += charset.charAt(Math.floor(Math.random() * n));\r\n        }\r\n        setPassword(retVal);\r\n        setShowPassword(true);\r\n    };\r\n\r\n    return (\r\n        <div style={{ padding: '2rem', maxWidth: '1200px', margin: '0 auto', animation: 'fadeIn 0.4s ease-out' }}>\r\n            <style jsx global>{`\r\n                @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }\r\n            `}</style>\r\n\r\n            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '2.5rem' }}>\r\n                <div>\r\n                    <h1 style={{ margin: 0, fontSize: '2rem', fontWeight: 850, color: 'var(--primary)', letterSpacing: '-0.02em' }}>\r\n                        Gestão de Profissionais\r\n                    </h1>\r\n                    <p style={{ color: 'var(--text-muted)', fontSize: '1rem', marginTop: '0.4rem', fontWeight: 500 }}>\r\n                        Controle central de acesso e dados dos médicos da clínica\r\n                    </p>\r\n                </div>\r\n                <Button\r\n                    variant={showForm ? 'secondary' : 'primary'}\r\n                    onClick={() => {\r\n                        if (showForm) resetForm();\r\n                        else setShowForm(true);\r\n                    }}\r\n                    style={{ borderRadius: '12px', padding: '0.75rem 1.5rem', fontWeight: 700, boxShadow: showForm ? 'none' : '0 4px 12px rgba(0, 45, 94, 0.2)' }}\r\n                >\r\n                    {showForm ? 'Cancelar' : (\r\n                        <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>\r\n                            <UserPlus size={18} />\r\n                            Novo Médico\r\n                        </div>\r\n                    )}\r\n                </Button>\r\n            </div>\r\n\r\n            {showForm && (\r\n                <Card\r\n                    style={{\r\n                        marginBottom: '2.5rem',\r\n                        border: 'none',\r\n                        boxShadow: '0 10px 40px rgba(0,0,0,0.08)',\r\n                        borderRadius: '20px',\r\n                        overflow: 'hidden'\r\n                    }}\r\n                >\r\n                    <div style={{ background: 'linear-gradient(135deg, var(--primary) 0%, #001f41 100%)', padding: '1.5rem 2rem', color: '#fff' }}>\r\n                        <h3 style={{ margin: 0, fontSize: '1.25rem', fontWeight: 800 }}>\r\n                            {isEditing ? 'Editar Médico' : 'Cadastrar Novo Médico'}\r\n                        </h3>\r\n                        <p style={{ margin: '0.25rem 0 0 0', opacity: 0.8, fontSize: '0.875rem' }}>\r\n                            {isEditing ? 'Atualize os dados ou altere a senha de acesso' : 'Preencha os dados e configure as credenciais de acesso'}\r\n                        </p>\r\n                    </div>\r\n\r\n                    <form onSubmit={handleSubmit} style={{ padding: '2rem', display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1.5rem' }}>\r\n                        {/* ... (First column: Personal Data - remains same) ... */}\r\n                        <div style={{ display: 'flex', flexDirection: 'column', gap: '1.5rem' }}>\r\n                            <div style={{ borderBottom: '1px solid var(--border)', paddingBottom: '0.5rem', marginBottom: '0.5rem' }}>\r\n                                <h4 style={{ margin: 0, fontSize: '0.875rem', color: 'var(--primary)', textTransform: 'uppercase', letterSpacing: '0.05em' }}>Dados Pessoais</h4>\r\n                            </div>\r\n                            <Input label=\"Nome Completo\" value={name} onChange={e => setName(e.target.value)} required placeholder=\"Ex: Dr. Roberto Silva\" />\r\n                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem' }}>\r\n                                <Input label=\"CRM\" value={crm} onChange={e => setCrm(e.target.value)} placeholder=\"000.000-UF\" />\r\n                                <Input label=\"Especialidade\" value={specialty} onChange={e => setSpecialty(e.target.value)} placeholder=\"Ex: Cardiologia\" />\r\n                            </div>\r\n                            <Input label=\"Celular\" value={phone} onChange={e => setPhone(e.target.value)} placeholder=\"(00) 00000-0000\" />\r\n                        </div>\r\n\r\n                        {/* ... (Second column: Credentials) ... */}\r\n                        <div style={{ display: 'flex', flexDirection: 'column', gap: '1.5rem' }}>\r\n                            <div style={{ borderBottom: '1px solid var(--border)', paddingBottom: '0.5rem', marginBottom: '0.5rem' }}>\r\n                                <h4 style={{ margin: 0, fontSize: '0.875rem', color: 'var(--primary)', textTransform: 'uppercase', letterSpacing: '0.05em' }}>Credenciais de Acesso</h4>\r\n                            </div>\r\n\r\n                            <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem', padding: '1rem', background: '#f8fafc', borderRadius: '12px', border: '1px solid var(--border)' }}>\r\n                                <input\r\n                                    type=\"checkbox\"\r\n                                    checked={createAuth}\r\n                                    onChange={e => setCreateAuth(e.target.checked)}\r\n                                    id=\"createAuth\"\r\n                                    disabled={isEditing && !!email} // Prevent unchecking if already has account\r\n                                    style={{ width: '18px', height: '18px', cursor: 'pointer' }}\r\n                                />\r\n                                <label htmlFor=\"createAuth\" style={{ fontWeight: 700, color: 'var(--primary)', cursor: 'pointer', fontSize: '0.9375rem' }}>\r\n                                    {isEditing ? 'Manter conta de acesso ativa' : 'Criar conta de acesso para este médico'}\r\n                                </label>\r\n                            </div>\r\n\r\n                            {createAuth && (\r\n                                <div style={{ display: 'flex', flexDirection: 'column', gap: '1.25rem', animation: 'fadeIn 0.2s ease-out' }}>\r\n                                    <Input\r\n                                        label=\"E-mail de Login\"\r\n                                        value={email}\r\n                                        onChange={e => setEmail(e.target.value)}\r\n                                        required\r\n                                        type=\"email\"\r\n                                        placeholder=\"medico@exemplo.com\"\r\n                                        disabled={isEditing} // Email is hard to change due to Auth linking\r\n                                    />\r\n                                    <div style={{ position: 'relative' }}>\r\n                                        <Input\r\n                                            label={isEditing ? \"Nova Senha (deixe em branco para manter)\" : \"Senha de Acesso\"}\r\n                                            value={password}\r\n                                            onChange={e => setPassword(e.target.value)}\r\n                                            required={!isEditing}\r\n                                            type={showPassword ? 'text' : 'password'}\r\n                                            placeholder={isEditing ? \"Nova senha...\" : \"Mínimo 6 caracteres\"}\r\n                                        />\r\n                                        <div style={{ position: 'absolute', right: '0.75rem', top: '2.3rem', display: 'flex', gap: '0.5rem' }}>\r\n                                            <button\r\n                                                type=\"button\"\r\n                                                onClick={() => setShowPassword(!showPassword)}\r\n                                                style={{ border: 'none', background: 'transparent', cursor: 'pointer', color: 'var(--text-muted)' }}\r\n                                            >\r\n                                                {showPassword ? <EyeOff size={18} /> : <Eye size={18} />}\r\n                                            </button>\r\n                                            <button\r\n                                                type=\"button\"\r\n                                                onClick={generatePassword}\r\n                                                style={{ border: 'none', background: 'transparent', cursor: 'pointer', color: 'var(--accent)', fontWeight: 700, fontSize: '0.75rem' }}\r\n                                            >\r\n                                                Gerar\r\n                                            </button>\r\n                                        </div>\r\n                                    </div>\r\n                                    <div style={{ fontSize: '0.75rem', color: 'var(--text-muted)', background: '#fffbeb', padding: '0.75rem', borderRadius: '8px', border: '1px solid #fef3c7' }}>\r\n                                        <strong>Atenção:</strong> {isEditing ? 'Se preenchida, a nova senha valerá imediatamente.' : 'Ao clicar em cadastrar, as credenciais serão ativadas imediatamente.'}\r\n                                    </div>\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n\r\n                        <div style={{ gridColumn: 'span 2', marginTop: '1rem', display: 'flex', justifyContent: 'flex-end' }}>\r\n                            <Button\r\n                                variant=\"primary\"\r\n                                type=\"submit\"\r\n                                disabled={isSaving}\r\n                                style={{ padding: '0.85rem 3rem', borderRadius: '12px', fontSize: '1rem', fontWeight: 800, background: 'var(--accent)' }}\r\n                            >\r\n                                {isSaving ? 'Processando...' : (isEditing ? 'Salvar Alterações' : 'Finalizar Cadastro Master')}\r\n                            </Button>\r\n                        </div>\r\n                    </form>\r\n                </Card>\r\n            )}\r\n\r\n            <Card padding=\"none\" style={{ borderRadius: '20px', border: 'none', boxShadow: '0 4px 20px rgba(0,0,0,0.05)', overflow: 'hidden' }}>\r\n                <Table headers={['Profissional', 'CRM / Especialidade', 'Contato', 'Status', 'Ações']}>\r\n                    {loading ? (\r\n                        <tr><td colSpan={5} style={{ textAlign: 'center', padding: '4rem' }}>\r\n                            <div style={{ color: 'var(--text-muted)' }}>Buscando base de médicos...</div>\r\n                        </td></tr>\r\n                    ) : doctors.length === 0 ? (\r\n                        <tr><td colSpan={5} style={{ textAlign: 'center', padding: '4rem' }}>Nenhum médico cadastrado.</td></tr>\r\n                    ) : doctors.map(doc => (\r\n                        <tr key={doc.id}>\r\n                            <td style={{ padding: '1.25rem' }}>\r\n                                <div style={{ display: 'flex', alignItems: 'center', gap: '1rem' }}>\r\n                                    <div style={{ width: '40px', height: '40px', borderRadius: '12px', background: 'var(--primary)', color: '#fff', display: 'flex', alignItems: 'center', justifyContent: 'center', fontWeight: 800 }}>\r\n                                        {doc.name.charAt(0).toUpperCase()}\r\n                                    </div>\r\n                                    <div>\r\n                                        <div style={{ fontWeight: 800, color: 'var(--primary)', fontSize: '1rem' }}>{doc.name}</div>\r\n                                        <div style={{ display: 'flex', alignItems: 'center', gap: '0.4rem', fontSize: '0.75rem', color: 'var(--text-muted)', marginTop: '0.1rem' }}>\r\n                                            {doc.profileId ? <ShieldCheck size={14} style={{ color: 'var(--success)' }} /> : <UserMinus size={14} />}\r\n                                            {doc.profileId ? 'Conta Vinculada' : 'Sem conta de acesso'}\r\n                                        </div>\r\n                                    </div>\r\n                                </div>\r\n                            </td>\r\n                            <td>\r\n                                <div>\r\n                                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.4rem', fontSize: '0.875rem', fontWeight: 700, color: 'var(--primary)' }}>\r\n                                        <Award size={14} /> {doc.specialty || 'Clínico'}\r\n                                    </div>\r\n                                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.4rem', fontSize: '0.75rem', color: 'var(--text-muted)', marginTop: '0.2rem' }}>\r\n                                        <Hash size={14} /> CRM: {doc.crm || '-'}\r\n                                    </div>\r\n                                </div>\r\n                            </td>\r\n                            <td>\r\n                                <div>\r\n                                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.4rem', fontSize: '0.8125rem', color: 'var(--text-muted)' }}>\r\n                                        <Mail size={14} /> {doc.email || '-'}\r\n                                    </div>\r\n                                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.4rem', fontSize: '0.8125rem', color: 'var(--text-muted)', marginTop: '0.2rem' }}>\r\n                                        <Phone size={14} /> {doc.phone || '-'}\r\n                                    </div>\r\n                                </div>\r\n                            </td>\r\n                            <td>\r\n                                <Badge variant={doc.active ? 'success' : 'secondary'} style={{ padding: '0.4rem 0.8rem', borderRadius: '8px', fontWeight: 800 }}>\r\n                                    {doc.active ? 'ATIVO' : 'INATIVO'}\r\n                                </Badge>\r\n                            </td>\r\n                            <td>\r\n                                <div style={{ display: 'flex', gap: '0.5rem' }}>\r\n                                    <Button\r\n                                        variant=\"secondary\"\r\n                                        size=\"sm\"\r\n                                        onClick={() => handleEdit(doc)}\r\n                                        style={{ borderRadius: '8px', fontWeight: 700 }}\r\n                                    >\r\n                                        Editar\r\n                                    </Button>\r\n                                    <Button\r\n                                        variant={doc.active ? 'outline' : 'primary'}\r\n                                        size=\"sm\"\r\n                                        onClick={() => toggleActive(doc)}\r\n                                        style={{ borderRadius: '8px', fontWeight: 700 }}\r\n                                    >\r\n                                        {doc.active ? 'Desativar' : 'Ativar'}\r\n                                    </Button>\r\n                                </div>\r\n                            </td>\r\n                        </tr>\r\n                    ))}\r\n                </Table>\r\n            </Card>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\app\\(dashboard)\\admin\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\app\\(dashboard)\\admin\\settings\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":39,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":39,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { useState, useEffect } from 'react';\r\nimport { Card } from '@/components/ui/Card';\r\nimport { Button } from '@/components/ui/Button';\r\nimport { Input } from '@/components/ui/Input';\r\nimport { fetchSettingsAction, updateSettingsAction } from '@/app/actions/admin';\r\nimport { ClinicSettings } from '@/features/admin/settings/types';\r\n\r\nexport default function SettingsAdminPage() {\r\n    const [settings, setSettings] = useState<ClinicSettings | null>(null);\r\n    const [loading, setLoading] = useState(true);\r\n    const [isSaving, setIsSaving] = useState(false);\r\n\r\n    useEffect(() => {\r\n        loadSettings();\r\n    }, []);\r\n\r\n    const loadSettings = async () => {\r\n        setLoading(true);\r\n        try {\r\n            const data = await fetchSettingsAction();\r\n            setSettings(data);\r\n        } catch (err) {\r\n            console.error(err);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    const handleSave = async (e: React.FormEvent) => {\r\n        e.preventDefault();\r\n        if (!settings) return;\r\n\r\n        setIsSaving(true);\r\n        try {\r\n            await updateSettingsAction(settings);\r\n            alert('Configurações atualizadas com sucesso!');\r\n        } catch (err) {\r\n            alert('Erro ao atualizar configurações');\r\n        } finally {\r\n            setIsSaving(false);\r\n        }\r\n    };\r\n\r\n    if (loading) return <div style={{ padding: '2rem' }}>Carregando configurações...</div>;\r\n    if (!settings) return <div style={{ padding: '2rem' }}>Erro ao carregar configurações.</div>;\r\n\r\n    return (\r\n        <div style={{ padding: '1.5rem', maxWidth: '800px' }}>\r\n            <h1 style={{ marginBottom: '0.5rem' }}>Configurações da Clínica</h1>\r\n            <p style={{ color: 'var(--text-muted)', marginBottom: '2rem' }}>Ajuste os parâmetros globais do sistema</p>\r\n\r\n            <form onSubmit={handleSave}>\r\n                <Card header=\"Identificação e Geral\" style={{ marginBottom: '1.5rem' }}>\r\n                    <div style={{ padding: '1rem', display: 'flex', flexDirection: 'column', gap: '1.5rem' }}>\r\n                        <Input\r\n                            label=\"Nome da Clínica\"\r\n                            value={settings.clinicName}\r\n                            onChange={e => setSettings({ ...settings, clinicName: e.target.value })}\r\n                        />\r\n                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem' }}>\r\n                            <Input\r\n                                label=\"Duração Padrão da Consulta (minutos)\"\r\n                                type=\"number\"\r\n                                value={settings.appointmentDurationMinutes}\r\n                                onChange={e => setSettings({ ...settings, appointmentDurationMinutes: parseInt(e.target.value) })}\r\n                            />\r\n                            <Input\r\n                                label=\"Prefixo da Senha (Fila)\"\r\n                                value={settings.queuePrefix}\r\n                                onChange={e => setSettings({ ...settings, queuePrefix: e.target.value })}\r\n                            />\r\n                        </div>\r\n                    </div>\r\n                </Card>\r\n\r\n                <Card header=\"Painel de TV\" style={{ marginBottom: '2rem' }}>\r\n                    <div style={{ padding: '1rem' }}>\r\n                        <Input\r\n                            label=\"Intervalo de Atualização do Painel (segundos)\"\r\n                            type=\"number\"\r\n                            value={settings.tvRefreshSeconds}\r\n                            onChange={e => setSettings({ ...settings, tvRefreshSeconds: parseInt(e.target.value) })}\r\n                        />\r\n                    </div>\r\n                </Card>\r\n\r\n                <div style={{ display: 'flex', justifyContent: 'flex-end' }}>\r\n                    <Button variant=\"primary\" type=\"submit\" disabled={isSaving} style={{ width: '200px' }}>\r\n                        {isSaving ? 'Salvando...' : 'Salvar Alterações'}\r\n                    </Button>\r\n                </div>\r\n            </form>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\app\\(dashboard)\\doctor\\agenda\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\app\\(dashboard)\\doctor\\consultation\\[id]\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\app\\(dashboard)\\doctor\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\app\\(dashboard)\\doctor\\queue\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\app\\(dashboard)\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\app\\(dashboard)\\patients\\[id]\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\app\\(dashboard)\\patients\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\app\\(dashboard)\\secretary\\agenda\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\app\\(dashboard)\\secretary\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\app\\(dashboard)\\secretary\\queue\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\app\\actions\\admin.ts","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'password' is assigned a value but never used.","line":225,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":225,"endColumn":25,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\app\\actions\\auth.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\app\\actions\\patients.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\app\\actions\\queue.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\app\\api\\documents\\[type]\\[id]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\app\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\app\\login\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\app\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\app\\tv\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\app\\unauthorized\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\components\\ui\\Badge.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\components\\ui\\Button.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\components\\ui\\Card.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\components\\ui\\Input.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\components\\ui\\Table.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\components\\ui\\Textarea.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\eslint.config.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\features\\admin\\settings\\repository.supabase.ts","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":30,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":30,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[978,981],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[978,981],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":50,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":50,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1968,1971],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1968,1971],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":56,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":56,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2238,2241],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2238,2241],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\features\\admin\\settings\\repository.types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\features\\admin\\settings\\service.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\features\\admin\\settings\\types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\features\\agenda\\__tests__\\service.test.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'beforeEach' is defined but never used.","line":1,"column":32,"nodeType":"Identifier","messageId":"unusedVar","endLine":1,"endColumn":42,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"beforeEach"},"fix":{"range":[29,41],"text":""},"desc":"Remove unused variable \"beforeEach\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { describe, it, expect, beforeEach } from 'vitest';\r\nimport { AppointmentService } from '../service';\r\nimport { AppointmentInput } from '../types';\r\n\r\ndescribe('AppointmentService', () => {\r\n    const doctorId = 'doc1';\r\n\r\n    it('should create an appointment if no conflict', async () => {\r\n        const input: AppointmentInput = {\r\n            doctorId,\r\n            patientId: 'p1',\r\n            patientName: 'Test Patient',\r\n            startTime: '2026-01-29T10:00:00',\r\n            endTime: '2026-01-29T10:30:00',\r\n            status: 'SCHEDULED'\r\n        };\r\n        const appt = await AppointmentService.create(input);\r\n        expect(appt.id).toBeDefined();\r\n    });\r\n\r\n    it('should detect conflict for overlapping time', async () => {\r\n        const input: AppointmentInput = {\r\n            doctorId,\r\n            patientId: 'p2',\r\n            patientName: 'Another Patient',\r\n            startTime: '2026-01-29T10:15:00', // Overlaps with 10:00-10:30\r\n            endTime: '2026-01-29T10:45:00',\r\n            status: 'SCHEDULED'\r\n        };\r\n\r\n        await expect(AppointmentService.create(input)).rejects.toThrow('Conflito de horário');\r\n    });\r\n\r\n    it('should allow adjacent appointments', async () => {\r\n        const input: AppointmentInput = {\r\n            doctorId,\r\n            patientId: 'p3',\r\n            patientName: 'Patient 3',\r\n            startTime: '2026-01-29T10:30:00', // Starts exactly when previous ends\r\n            endTime: '2026-01-29T11:00:00',\r\n            status: 'SCHEDULED'\r\n        };\r\n\r\n        await expect(AppointmentService.create(input)).resolves.toBeDefined();\r\n    });\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\features\\agenda\\actions.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":27,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":27,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use server';\r\n\r\nimport { AppointmentService } from './service';\r\nimport { QueueService } from '../queue/service';\r\nimport { AppointmentInput, Appointment, AppointmentStatus } from './types';\r\nimport { revalidatePath } from 'next/cache';\r\nimport { requireRole } from '@/lib/session';\r\nimport { logAudit } from '@/lib/audit';\r\n\r\nexport type ActionState = {\r\n    error?: string;\r\n    success?: boolean;\r\n    appointment?: Appointment;\r\n};\r\n\r\nexport async function createAppointmentAction(prevState: ActionState, formData: FormData): Promise<ActionState> {\r\n    try {\r\n        // Enforce RBAC\r\n        await requireRole(['ADMIN', 'SECRETARY']);\r\n\r\n        // Fetch duration from settings\r\n        let duration = 30;\r\n        try {\r\n            const { fetchSettingsAction } = await import('@/app/actions/admin');\r\n            const settings = await fetchSettingsAction();\r\n            duration = settings.appointmentDurationMinutes;\r\n        } catch (e) {\r\n            console.warn('createAppointmentAction: Using default duration 30 due to settings error');\r\n        }\r\n\r\n        const date = formData.get('date') as string;\r\n        const time = formData.get('time') as string;\r\n        const doctorId = formData.get('doctorId') as string;\r\n        const patientId = formData.get('patientId') as string;\r\n        const patientName = formData.get('patientName') as string;\r\n        const notes = formData.get('notes') as string;\r\n\r\n        if (!date || !time || !doctorId || !patientId) {\r\n            return { error: 'Missing required fields', success: false };\r\n        }\r\n\r\n        // Explicitly set as BRT (-03:00) to ensure database stores the intended local time\r\n        const startTime = `${date}T${time}:00-03:00`;\r\n        const startDate = new Date(startTime);\r\n        const endDate = new Date(startDate.getTime() + duration * 60000);\r\n\r\n        // Convert to ISO-like format but keeping it relative to database precision\r\n        // Use toISOString() which adds Z, or manually format to avoid shifts if needed.\r\n        // Actually, toISOString() is fine if we include the offset in the input.\r\n        const endTime = endDate.toISOString();\r\n\r\n        const input: AppointmentInput = {\r\n            patientId,\r\n            patientName,\r\n            doctorId,\r\n            startTime,\r\n            endTime,\r\n            status: 'SCHEDULED',\r\n            notes: notes || undefined,\r\n        };\r\n\r\n        const appointment = await AppointmentService.create(input);\r\n\r\n        await logAudit('CREATE', 'APPOINTMENT', appointment.id, {\r\n            patientName: appointment.patientName,\r\n            doctorId: appointment.doctorId,\r\n            startTime: appointment.startTime\r\n        });\r\n\r\n        revalidatePath('/doctor/agenda');\r\n        revalidatePath('/secretary/agenda');\r\n\r\n        // Logic to auto-add to queue if appointment is today\r\n        try {\r\n            // Get today's date in Brazil time for accurate auto-queue logic\r\n            const todayLocal = new Intl.DateTimeFormat('en-CA', { timeZone: 'America/Sao_Paulo' }).format(new Date());\r\n\r\n            console.log('[createAppointmentAction] Comparing date:', date, 'with todayLocal:', todayLocal);\r\n\r\n            if (date === todayLocal) {\r\n                console.log('[createAppointmentAction] Auto-adding to queue for today...');\r\n                const user = await import('@/lib/session').then(m => m.getCurrentUser());\r\n                const role = user?.role || 'SECRETARY';\r\n\r\n                await QueueService.add({\r\n                    patientId: appointment.patientId,\r\n                    doctorId: appointment.doctorId,\r\n                    appointmentId: appointment.id,\r\n                    status: 'WAITING'\r\n                }, role);\r\n\r\n                revalidatePath('/queue');\r\n                revalidatePath('/tv');\r\n                revalidatePath('/secretary/queue');\r\n                revalidatePath('/doctor/queue');\r\n            }\r\n        } catch (queueErr) {\r\n            console.error('Failed to auto-add to queue:', queueErr);\r\n        }\r\n\r\n        return { success: true, appointment };\r\n    } catch (err: unknown) {\r\n        console.error('Create Appointment Error:', err);\r\n        const msg = err instanceof Error ? err.message : 'Unknown error';\r\n        return { error: msg, success: false };\r\n    }\r\n}\r\n\r\nexport async function updateAppointmentStatusAction(id: string, status: AppointmentStatus): Promise<Appointment | null> {\r\n    try {\r\n        const appointment = await AppointmentService.updateStatus(id, status);\r\n\r\n        if (appointment) {\r\n            await logAudit('STATUS_CHANGE', 'APPOINTMENT', id, { status });\r\n        }\r\n\r\n        revalidatePath('/doctor/agenda');\r\n        revalidatePath('/secretary/agenda');\r\n        return appointment;\r\n    } catch (err) {\r\n        console.error('Update Status Error:', err);\r\n        return null;\r\n    }\r\n}\r\n\r\nexport async function checkConflictAction(doctorId: string, startTime: string, endTime: string): Promise<boolean> {\r\n    return AppointmentService.checkConflict(doctorId, startTime, endTime);\r\n}\r\n\r\nimport { SupabaseAppointmentsRepository } from './repository.supabase';\r\nimport { supabaseServer } from '@/lib/supabase-server';\r\n\r\nexport async function fetchAppointmentsAction(doctorId?: string, startRange?: string, endRange?: string): Promise<Appointment[]> {\r\n    try {\r\n        const user = await requireRole(['ADMIN', 'SECRETARY', 'DOCTOR']);\r\n        const clinicId = user.clinicId || '550e8400-e29b-41d4-a716-446655440000';\r\n        const repo = new SupabaseAppointmentsRepository(supabaseServer, clinicId);\r\n        return await repo.list(doctorId, startRange, endRange);\r\n    } catch (e) {\r\n        console.error('fetchAppointmentsAction: Failed to fetch appointments', e);\r\n        return [];\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\features\\agenda\\components\\AppointmentModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\features\\agenda\\components\\WeeklyCalendar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\features\\agenda\\repository.mock.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\features\\agenda\\repository.supabase.ts","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":114,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":114,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3937,3940],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3937,3940],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\features\\agenda\\repository.types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\features\\agenda\\service.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\features\\agenda\\types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\features\\auth\\__tests__\\auth.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\features\\auth\\service.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":41,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":41,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { User, Role } from './types';\r\nimport { logAudit } from '@/lib/audit';\r\n\r\n// Mock database\r\nconst MOCK_USERS: Record<string, User> = {\r\n    'admin': { id: 'u1', name: 'Admin User', email: 'admin@sdmed.sys', role: 'ADMIN' },\r\n    'sec': { id: 'u2', name: 'Secretary User', email: 'secretary@sdmed.sys', role: 'SECRETARY' },\r\n    'doc': { id: 'u3', name: 'Doctor User', email: 'doctor@sdmed.sys', role: 'DOCTOR' },\r\n};\r\n\r\nexport class AuthService {\r\n    static async login(username: string): Promise<{ user: User; token: string } | null> {\r\n        // Simulate DB delay\r\n        await new Promise(resolve => setTimeout(resolve, 500));\r\n\r\n        const user = MOCK_USERS[username];\r\n        if (!user) {\r\n            await logAudit('LOGIN_FAILURE', 'AUTH', username, { reason: 'User not found' });\r\n            return null;\r\n        }\r\n\r\n        // In a real app, this would be a JWT signed by the server\r\n        const token = btoa(JSON.stringify({ id: user.id, role: user.role }));\r\n\r\n        await logAudit('LOGIN', 'AUTH', user.id, { email: user.email, role: user.role });\r\n\r\n        return { user, token };\r\n    }\r\n\r\n    static async getUser(token: string): Promise<User | null> {\r\n        try {\r\n            const payload = JSON.parse(atob(token));\r\n\r\n            // In real app, verify DB validity\r\n            return {\r\n                id: payload.id,\r\n                name: 'Mock User',\r\n                email: 'mock@test.com',\r\n                role: payload.role as Role\r\n            };\r\n        } catch (err) {\r\n            return null;\r\n        }\r\n    }\r\n\r\n    static async logout(): Promise<void> {\r\n        // Since we don't have the user ID here easily in this mock, \r\n        // a real implementation would extract it from the token first.\r\n        await logAudit('LOGOUT', 'AUTH', 'current-session');\r\n        await new Promise(resolve => setTimeout(resolve, 200));\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\features\\auth\\types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\features\\consultation\\__tests__\\documents.test.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":53,"column":67,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":53,"endColumn":70,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1717,1720],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1717,1720],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":84,"column":67,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":84,"endColumn":70,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2858,2861],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2858,2861],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { describe, it, expect, vi, beforeEach } from 'vitest';\r\nimport { ClinicalDocumentService } from '../service.documents';\r\nimport { getCurrentUser } from '@/lib/session';\r\nimport { createClient } from '@/lib/supabase-auth';\r\n\r\n// Mock dependencies\r\nvi.mock('@/lib/session');\r\nvi.mock('@/lib/supabase-auth');\r\nvi.mock('@/lib/audit');\r\n\r\ndescribe('ClinicalDocumentService (RBAC)', () => {\r\n    beforeEach(() => {\r\n        vi.clearAllMocks();\r\n    });\r\n\r\n    it('should deny access to SECRETARY', async () => {\r\n        vi.mocked(getCurrentUser).mockResolvedValue({\r\n            id: 'sec-1',\r\n            role: 'SECRETARY',\r\n            name: 'Secretary',\r\n            clinicId: 'c1'\r\n        });\r\n\r\n        const data = await ClinicalDocumentService.getDocumentData('cons-1');\r\n        expect(data).toBeNull();\r\n    });\r\n\r\n    it('should allow DOCTOR only if owner', async () => {\r\n        vi.mocked(getCurrentUser).mockResolvedValue({\r\n            id: 'doc-1',\r\n            role: 'DOCTOR',\r\n            name: 'Dr. House',\r\n            clinicId: 'c1'\r\n        });\r\n\r\n        const mockSupabase = {\r\n            from: vi.fn().mockReturnThis(),\r\n            select: vi.fn().mockReturnThis(),\r\n            eq: vi.fn().mockReturnThis(),\r\n            single: vi.fn().mockResolvedValue({\r\n                data: {\r\n                    id: 'cons-1',\r\n                    doctor_user_id: 'doc-2', // Different doctor\r\n                    clinic_id: 'c1',\r\n                    clinical_entries: [{}],\r\n                    patients: {},\r\n                    clinic_settings: {}\r\n                },\r\n                error: null\r\n            })\r\n        };\r\n\r\n        vi.mocked(createClient).mockResolvedValue(mockSupabase as any);\r\n\r\n        const data = await ClinicalDocumentService.getDocumentData('cons-1');\r\n        expect(data).toBeNull(); // Should be null because doc-1 !== doc-2\r\n    });\r\n\r\n    it('should allow ADMIN to access any consultation in their clinic', async () => {\r\n        vi.mocked(getCurrentUser).mockResolvedValue({\r\n            id: 'admin-1',\r\n            role: 'ADMIN',\r\n            name: 'Admin',\r\n            clinicId: 'c1'\r\n        });\r\n\r\n        const mockSupabase = {\r\n            from: vi.fn().mockReturnThis(),\r\n            select: vi.fn().mockReturnThis(),\r\n            eq: vi.fn().mockReturnThis(),\r\n            single: vi.fn().mockResolvedValue({\r\n                data: {\r\n                    id: 'cons-1',\r\n                    doctor_user_id: 'doc-2',\r\n                    clinic_id: 'c1',\r\n                    clinical_entries: [{ conduct: 'Prescription text' }],\r\n                    patients: { name: 'Patient X' },\r\n                    clinic_settings: { clinic_name: 'SDMED' }\r\n                },\r\n                error: null\r\n            })\r\n        };\r\n\r\n        vi.mocked(createClient).mockResolvedValue(mockSupabase as any);\r\n\r\n        const data = await ClinicalDocumentService.getDocumentData('cons-1');\r\n        expect(data).not.toBeNull();\r\n        expect(data?.patient.name).toBe('Patient X');\r\n    });\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\features\\consultation\\__tests__\\service.test.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'vi' is defined but never used.","line":1,"column":32,"nodeType":"Identifier","messageId":"unusedVar","endLine":1,"endColumn":34,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"vi"},"fix":{"range":[29,33],"text":""},"desc":"Remove unused variable \"vi\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'queueList' is assigned a value but never used.","line":55,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":55,"endColumn":24}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { describe, it, expect, vi } from 'vitest';\r\nimport { ConsultationService } from '../service';\r\nimport { QueueService } from '@/features/queue/service';\r\n\r\ndescribe('ConsultationService', () => {\r\n    let queueItemId: string;\r\n    const doctorId = 'doc1';\r\n\r\n    it('should start consultation from queue item', async () => {\r\n        // Setup Queue Item\r\n        const item = await QueueService.add({ status: 'WAITING', patientId: 'p1' }, 'SECRETARY');\r\n        // Simulate Doctor Calling and Starting\r\n        await QueueService.changeStatus(item.id, 'CALLED', 'DOCTOR');\r\n        await QueueService.changeStatus(item.id, 'IN_SERVICE', 'DOCTOR');\r\n\r\n        queueItemId = item.id;\r\n\r\n        const consult = await ConsultationService.start({\r\n            doctorId,\r\n            patientId: 'p1',\r\n            queueItemId\r\n        });\r\n\r\n        expect(consult.id).toBeDefined();\r\n        expect(consult.startedAt).toBeDefined();\r\n        expect(consult.finishedAt).toBeNull();\r\n    });\r\n\r\n    it('should active consultation by doctor', async () => {\r\n        const active = await ConsultationService.getActiveByDoctor(doctorId);\r\n        expect(active).toBeDefined();\r\n        expect(active?.queueItemId).toBe(queueItemId);\r\n    });\r\n\r\n    it('should update clinical notes', async () => {\r\n        const active = await ConsultationService.getActiveByDoctor(doctorId);\r\n        if (!active) throw new Error('No active consultation');\r\n\r\n        await ConsultationService.updateNotes(active.id, 'Patient complains of headache', doctorId);\r\n\r\n        const updated = await ConsultationService.findById(active.id);\r\n        expect(updated?.clinicalNotes).toBe('Patient complains of headache');\r\n    });\r\n\r\n    it('should finish consultation and update queue', async () => {\r\n        const active = await ConsultationService.getActiveByDoctor(doctorId);\r\n        if (!active) throw new Error('No active consultation');\r\n\r\n        await ConsultationService.finish(active.id, doctorId);\r\n\r\n        const finished = await ConsultationService.findById(active.id);\r\n        expect(finished?.finishedAt).toBeDefined();\r\n\r\n        // Check Queue Status\r\n        const queueList = await QueueService.list();\r\n        // Since list filters out DONE, we might check differently or trust implementation.\r\n        // But for mock verification, let's verify logic didn't throw.\r\n    });\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\features\\consultation\\__tests__\\summary.test.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'createClient' is defined but never used.","line":4,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":22,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"createClient"},"fix":{"range":[175,226],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":46,"column":108,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":46,"endColumn":111,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1541,1544],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1541,1544],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { describe, it, expect, vi, beforeEach } from 'vitest';\r\nimport { ClinicalSummaryService } from '../service.summary';\r\nimport { getCurrentUser } from '@/lib/session';\r\nimport { createClient } from '@/lib/supabase-auth';\r\nimport { SupabaseClinicalEntryRepository } from '../repository.clinical.supabase';\r\n\r\n// Mock dependencies\r\nvi.mock('@/lib/session');\r\nvi.mock('@/lib/supabase-auth');\r\nvi.mock('../repository.clinical.supabase');\r\n\r\ndescribe('ClinicalSummaryService', () => {\r\n    beforeEach(() => {\r\n        vi.clearAllMocks();\r\n    });\r\n\r\n    it('should return null if user is SECRETARY', async () => {\r\n        vi.mocked(getCurrentUser).mockResolvedValue({\r\n            id: 'u1',\r\n            role: 'SECRETARY',\r\n            name: 'Sec',\r\n            clinicId: 'c1'\r\n        });\r\n\r\n        const summary = await ClinicalSummaryService.getLatestEntryByPatient('p1');\r\n        expect(summary).toBeNull();\r\n    });\r\n\r\n    it('should return latest summary for DOCTOR', async () => {\r\n        vi.mocked(getCurrentUser).mockResolvedValue({\r\n            id: 'u1',\r\n            role: 'DOCTOR',\r\n            name: 'Doc',\r\n            clinicId: 'c1'\r\n        });\r\n\r\n        const mockEntry = {\r\n            id: 'e1',\r\n            diagnosis: 'Test Diagnosis',\r\n            conduct: 'Test Conduct',\r\n            doctorUserId: 'doc-123',\r\n            createdAt: '2026-01-30T10:00:00Z',\r\n            // ... other fields\r\n        };\r\n\r\n        vi.mocked(SupabaseClinicalEntryRepository.prototype.listByPatient).mockResolvedValue([mockEntry as any]);\r\n\r\n        const summary = await ClinicalSummaryService.getLatestEntryByPatient('p1');\r\n\r\n        expect(summary).not.toBeNull();\r\n        expect(summary?.diagnosis).toBe('Test Diagnosis');\r\n        expect(summary?.doctorName).toContain('doc-1');\r\n        expect(summary?.date).toBe('2026-01-30T10:00:00Z');\r\n    });\r\n\r\n    it('should return null if no clinical entries found', async () => {\r\n        vi.mocked(getCurrentUser).mockResolvedValue({\r\n            id: 'u1',\r\n            role: 'DOCTOR',\r\n            name: 'Doc',\r\n            clinicId: 'c1'\r\n        });\r\n\r\n        vi.mocked(SupabaseClinicalEntryRepository.prototype.listByPatient).mockResolvedValue([]);\r\n\r\n        const summary = await ClinicalSummaryService.getLatestEntryByPatient('p1');\r\n        expect(summary).toBeNull();\r\n    });\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\features\\consultation\\actions.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'user' is assigned a value but never used.","line":76,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":76,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use server';\r\n\r\nimport { ConsultationService } from './service';\r\nimport { ClinicalEntryService } from './service.clinical';\r\nimport { ConsultationInput, Consultation, ClinicalEntry, ClinicalEntryInput } from './types';\r\nimport { revalidatePath } from 'next/cache';\r\nimport { requireRole } from '@/lib/session';\r\nimport { logAudit } from '@/lib/audit';\r\n\r\nexport type ActionState = {\r\n    error?: string;\r\n    success?: boolean;\r\n    consultation?: Consultation;\r\n    entry?: ClinicalEntry;\r\n};\r\n\r\nexport async function startConsultationAction(prevState: ActionState, formData: FormData): Promise<ActionState> {\r\n    try {\r\n        const user = await requireRole(['DOCTOR']);\r\n        const doctorId = user.id;\r\n\r\n        const queueItemId = formData.get('queueItemId') as string;\r\n        const patientId = formData.get('patientId') as string;\r\n\r\n        const input: ConsultationInput = {\r\n            patientId,\r\n            doctorId,\r\n            queueItemId\r\n        };\r\n\r\n        const consultation = await ConsultationService.start(input);\r\n\r\n        await logAudit('CREATE', 'CONSULTATION', consultation.id, {\r\n            patientId,\r\n            queueItemId\r\n        });\r\n\r\n        revalidatePath('/doctor/consultation');\r\n        revalidatePath('/doctor/queue');\r\n        return { success: true, consultation };\r\n    } catch (err: unknown) {\r\n        console.error('Start Consultation Error:', err);\r\n        const msg = err instanceof Error ? err.message : 'Unknown error';\r\n        return { error: msg || 'Failed to start consultation', success: false };\r\n    }\r\n}\r\n\r\n// --- Clinical Entry Actions ---\r\n\r\nexport async function upsertClinicalEntryAction(input: ClinicalEntryInput & { id?: string }): Promise<ActionState> {\r\n    try {\r\n        const user = await requireRole(['DOCTOR']);\r\n        // Ensure doctorUserId is the current user\r\n        const entry = await ClinicalEntryService.upsert({\r\n            ...input,\r\n            doctorUserId: user.id\r\n        });\r\n\r\n        await logAudit('UPDATE', 'CLINICAL_ENTRY', entry.id, {\r\n            patientId: entry.patientId,\r\n            isFinal: entry.isFinal\r\n        });\r\n\r\n        revalidatePath(`/doctor/consultation`);\r\n        revalidatePath(`/patients/${entry.patientId}`);\r\n        return { success: true, entry };\r\n    } catch (err: unknown) {\r\n        console.error('Upsert Clinical Entry Error:', err);\r\n        const msg = err instanceof Error ? err.message : 'Unknown error';\r\n        return { error: msg, success: false };\r\n    }\r\n}\r\n\r\nexport async function finalizeClinicalEntryAction(id: string): Promise<ActionState> {\r\n    try {\r\n        const user = await requireRole(['DOCTOR']);\r\n        const entry = await ClinicalEntryService.finalize(id);\r\n\r\n        await logAudit('FINALIZE', 'CLINICAL_ENTRY', entry.id, {\r\n            patientId: entry.patientId\r\n        });\r\n\r\n        revalidatePath(`/doctor/consultation`);\r\n        revalidatePath(`/patients/${entry.patientId}`);\r\n        return { success: true, entry };\r\n    } catch (err: unknown) {\r\n        console.error('Finalize Clinical Entry Error:', err);\r\n        const msg = err instanceof Error ? err.message : 'Unknown error';\r\n        return { error: msg, success: false };\r\n    }\r\n}\r\n\r\nexport async function getPatientTimelineAction(patientId: string): Promise<ClinicalEntry[]> {\r\n    try {\r\n        await requireRole(['DOCTOR', 'ADMIN']);\r\n        return await ClinicalEntryService.listByPatient(patientId);\r\n    } catch (err) {\r\n        console.error('Get Patient Timeline Error:', err);\r\n        return [];\r\n    }\r\n}\r\n\r\n// Deprecated: Keeping for backward compatibility but redirecting to new logic if possible\r\nexport async function updateClinicalNotesAction(id: string, notes: string): Promise<{ success: boolean, error?: string }> {\r\n    try {\r\n        const user = await requireRole(['DOCTOR']);\r\n        // Attempt to find or create entry for this consultation\r\n        const existing = await ClinicalEntryService.findByConsultation(id);\r\n\r\n        await ClinicalEntryService.upsert({\r\n            id: existing?.id,\r\n            consultationId: id,\r\n            patientId: existing?.patientId || '', // This is a bit weak for legacy notes update\r\n            doctorUserId: user.id,\r\n            freeNotes: notes,\r\n            isFinal: false,\r\n            chiefComplaint: existing?.chiefComplaint || null,\r\n            diagnosis: existing?.diagnosis || null,\r\n            conduct: existing?.conduct || null,\r\n            observations: existing?.observations || null,\r\n        });\r\n\r\n        revalidatePath(`/doctor/consultation`);\r\n        return { success: true };\r\n    } catch (err: unknown) {\r\n        const msg = err instanceof Error ? err.message : 'Unknown error';\r\n        return { success: false, error: msg };\r\n    }\r\n}\r\n\r\nexport async function finishConsultationAction(id: string): Promise<{ success: boolean, error?: string }> {\r\n    try {\r\n        const user = await requireRole(['DOCTOR']);\r\n\r\n        // Also finalize clinical entry if it exists\r\n        const entry = await ClinicalEntryService.findByConsultation(id);\r\n        if (entry && !entry.isFinal) {\r\n            await ClinicalEntryService.finalize(entry.id);\r\n        }\r\n\r\n        await ConsultationService.finish(id, user.id);\r\n        await logAudit('STATUS_CHANGE', 'CONSULTATION', id, { status: 'FINISHED' });\r\n\r\n        revalidatePath('/doctor/queue');\r\n        revalidatePath('/doctor/consultation');\r\n        return { success: true };\r\n    } catch (err: unknown) {\r\n        const msg = err instanceof Error ? err.message : 'Unknown error';\r\n        return { success: false, error: msg };\r\n    }\r\n}\r\n\r\nexport async function getConsultationAction(id: string): Promise<Consultation | undefined> {\r\n    return await ConsultationService.findById(id);\r\n}\r\n\r\nexport async function getClinicalEntryAction(consultationId: string): Promise<ClinicalEntry | null> {\r\n    try {\r\n        await requireRole(['DOCTOR']);\r\n        return await ClinicalEntryService.findByConsultation(consultationId);\r\n    } catch (err) {\r\n        console.error('Get Clinical Entry Error:', err);\r\n        return null;\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\features\\consultation\\components\\ConsultationWorkspace.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'useEffect' is defined but never used.","line":3,"column":20,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":29,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"useEffect"},"fix":{"range":[34,45],"text":""},"desc":"Remove unused variable \"useEffect\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'finalizeClinicalEntryAction' is defined but never used.","line":5,"column":63,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":90,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"finalizeClinicalEntryAction"},"fix":{"range":[221,250],"text":""},"desc":"Remove unused variable \"finalizeClinicalEntryAction\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Input' is defined but never used.","line":9,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":9,"endColumn":15,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"Input"},"fix":{"range":[448,494],"text":""},"desc":"Remove unused import declaration."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { useState, useEffect } from 'react';\r\nimport { Consultation, ClinicalEntry, ClinicalEntryInput } from '@/features/consultation/types';\r\nimport { upsertClinicalEntryAction, finishConsultationAction, finalizeClinicalEntryAction } from '../actions';\r\nimport PatientTimeline from '@/features/patients/components/PatientTimeline';\r\nimport { Button } from '@/components/ui/Button';\r\nimport { Card } from '@/components/ui/Card';\r\nimport { Input } from '@/components/ui/Input';\r\nimport styles from '../styles/Consultation.module.css';\r\n\r\ninterface Props {\r\n    consultation: Consultation;\r\n    patientName: string;\r\n    initialEntry?: ClinicalEntry;\r\n    timeline: ClinicalEntry[];\r\n}\r\n\r\nexport default function ConsultationWorkspace({ consultation, patientName, initialEntry, timeline }: Props) {\r\n    const [entry, setEntry] = useState<Partial<ClinicalEntry>>(initialEntry || {\r\n        consultationId: consultation.id,\r\n        patientId: consultation.patientId,\r\n        chiefComplaint: '',\r\n        diagnosis: '',\r\n        conduct: '',\r\n        observations: '',\r\n        freeNotes: '',\r\n        isFinal: false\r\n    });\r\n    const [saving, setSaving] = useState(false);\r\n    const [lastSaved, setLastSaved] = useState<Date | null>(null);\r\n\r\n    const handleSave = async (isFinal = false) => {\r\n        if (entry.isFinal && !isFinal) return; // Locked\r\n\r\n        setSaving(true);\r\n        try {\r\n            // entry is Partial<ClinicalEntry>, but upsert needs ClinicalEntryInput\r\n            // We cast to ClinicalEntryInput based on fields we have. \r\n            // Warning: mandatory fields must be present or handled by Service/DB default.\r\n            const payload = {\r\n                ...entry,\r\n                isFinal: isFinal\r\n            } as ClinicalEntryInput & { id?: string };\r\n\r\n            const res = await upsertClinicalEntryAction(payload);\r\n            if (res.success && res.entry) {\r\n                setEntry(res.entry);\r\n                setLastSaved(new Date());\r\n            }\r\n        } catch (err) {\r\n            console.error('Save failed:', err);\r\n        } finally {\r\n            setSaving(false);\r\n        }\r\n    };\r\n\r\n    const updateField = <K extends keyof ClinicalEntry>(field: K, value: ClinicalEntry[K]) => {\r\n        setEntry(prev => ({ ...prev, [field]: value }));\r\n    };\r\n\r\n    return (\r\n        <div className={styles.container}>\r\n            <header className={styles.header}>\r\n                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', width: '100%' }}>\r\n                    <div>\r\n                        <h1 className={styles.patientName}>{patientName}</h1>\r\n                        <div className={styles.meta}>\r\n                            <div className={styles.metaItem}>\r\n                                <span>📅</span> {new Date(consultation.startedAt).toLocaleDateString('pt-BR')}\r\n                            </div>\r\n                            <div className={styles.metaItem}>\r\n                                <span>🕒</span> Iniciado às {new Date(consultation.startedAt).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                    <div className={styles.saveStatus}>\r\n                        {saving ? (\r\n                            <span style={{ color: 'var(--primary)' }}>◌ Salvando...</span>\r\n                        ) : lastSaved ? (\r\n                            <span style={{ color: 'var(--success)' }}>✓ Salvo {lastSaved.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}</span>\r\n                        ) : null}\r\n                    </div>\r\n                </div>\r\n            </header>\r\n\r\n            <div className={styles.workspaceGrid}>\r\n                <Card header=\"Atendimento Estruturado\">\r\n                    <div style={{ padding: '1.5rem', display: 'flex', flexDirection: 'column', gap: '1.5rem' }}>\r\n                        <div style={{ display: 'grid', gridTemplateColumns: '1fr', gap: '1rem' }}>\r\n                            <label className={styles.label}>Queixa Principal</label>\r\n                            <textarea\r\n                                className={styles.smallTextarea}\r\n                                value={entry.chiefComplaint || ''}\r\n                                onChange={(e) => updateField('chiefComplaint', e.target.value)}\r\n                                onBlur={() => handleSave()}\r\n                                placeholder=\"Relato do paciente...\"\r\n                            />\r\n\r\n                            <label className={styles.label}>Diagnóstico / Hipótese</label>\r\n                            <textarea\r\n                                className={styles.smallTextarea}\r\n                                value={entry.diagnosis || ''}\r\n                                onChange={(e) => updateField('diagnosis', e.target.value)}\r\n                                onBlur={() => handleSave()}\r\n                                placeholder=\"CID ou descrição clínica...\"\r\n                            />\r\n\r\n                            <label className={styles.label}>Conduta / Prescrição</label>\r\n                            <textarea\r\n                                className={styles.smallTextarea}\r\n                                value={entry.conduct || ''}\r\n                                onChange={(e) => updateField('conduct', e.target.value)}\r\n                                onBlur={() => handleSave()}\r\n                                placeholder=\"Medicamentos, exames, orientações...\"\r\n                            />\r\n                        </div>\r\n                    </div>\r\n                </Card>\r\n\r\n                <div className={styles.sideNotes}>\r\n                    <Card header=\"Histórico do Paciente\">\r\n                        <div style={{ padding: '0.5rem', maxHeight: '400px', overflowY: 'auto' }}>\r\n                            <PatientTimeline entries={timeline.filter(e => e.id !== entry.id)} />\r\n                        </div>\r\n                    </Card>\r\n\r\n                    <div style={{ marginTop: '1.5rem' }}>\r\n                        <Card header=\"Notas Livres & Evolução\">\r\n                            <div style={{ padding: '1rem' }}>\r\n                                <textarea\r\n                                    className={styles.mainTextarea}\r\n                                    value={entry.freeNotes || ''}\r\n                                    onChange={(e) => updateField('freeNotes', e.target.value)}\r\n                                    onBlur={() => handleSave()}\r\n                                    placeholder=\"Outras informações relevantes...\"\r\n                                />\r\n                            </div>\r\n                        </Card>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            <footer className={styles.footer}>\r\n                <Button\r\n                    variant=\"ghost\"\r\n                    onClick={() => handleSave()}\r\n                    disabled={saving || entry.isFinal}\r\n                >\r\n                    Salvar Rascunho\r\n                </Button>\r\n\r\n                <div style={{ display: 'flex', gap: '0.5rem' }}>\r\n                    <a\r\n                        href={`/api/documents/prescription/${consultation.id}`}\r\n                        target=\"_blank\"\r\n                        rel=\"noreferrer\"\r\n                        className={styles.pdfLink}\r\n                    >\r\n                        📄 Receita (PDF)\r\n                    </a>\r\n                    <a\r\n                        href={`/api/documents/certificate/${consultation.id}?days=1`}\r\n                        target=\"_blank\"\r\n                        rel=\"noreferrer\"\r\n                        className={styles.pdfLink}\r\n                    >\r\n                        📜 Atestado (PDF)\r\n                    </a>\r\n                </div>\r\n\r\n                <form action={async () => {\r\n                    if (confirm('Deseja FINALIZAR o prontuário? Após finalizado, o registro não poderá mais ser editado.')) {\r\n                        await handleSave(true);\r\n                        await finishConsultationAction(consultation.id);\r\n                    }\r\n                }}>\r\n                    <Button\r\n                        type=\"submit\"\r\n                        variant=\"accent\"\r\n                        size=\"lg\"\r\n                        disabled={saving || entry.isFinal}\r\n                    >\r\n                        {entry.isFinal ? 'Atendimento Finalizado' : 'Finalizar Atendimento'}\r\n                    </Button>\r\n                </form>\r\n            </footer>\r\n\r\n            {entry.isFinal && (\r\n                <div style={{\r\n                    position: 'fixed',\r\n                    top: '1rem',\r\n                    right: '1rem',\r\n                    backgroundColor: 'var(--success)',\r\n                    color: 'white',\r\n                    padding: '0.5rem 1rem',\r\n                    borderRadius: '20px',\r\n                    fontWeight: 'bold',\r\n                    boxShadow: '0 2px 10px rgba(0,0,0,0.1)'\r\n                }}>\r\n                    🔒 REGISTRO FINALIZADO\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\features\\consultation\\components\\DoctorWorklist.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\features\\consultation\\repository.clinical.supabase.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_profiles' is defined but never used.","line":95,"column":42,"nodeType":"Identifier","messageId":"unusedVar","endLine":95,"endColumn":51}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":25,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":25,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[959,962],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[959,962],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":62,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":62,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2241,2244],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2241,2244],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":95,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":95,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3352,3355],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3352,3355],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":95,"column":54,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":95,"endColumn":57,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3369,3372],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3369,3372],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { SupabaseClient } from '@supabase/supabase-js';\r\nimport { ClinicalEntry, ClinicalEntryInput } from './types';\r\nimport { IClinicalEntryRepository } from './repository.clinical.types';\r\n\r\nexport class SupabaseClinicalEntryRepository implements IClinicalEntryRepository {\r\n    constructor(\r\n        private supabase: SupabaseClient,\r\n        private clinicId: string\r\n    ) { }\r\n\r\n    async listByPatient(patientId: string): Promise<ClinicalEntry[]> {\r\n        const { data, error } = await this.supabase\r\n            .from('clinical_entries')\r\n            .select('*')\r\n            .eq('patient_id', patientId)\r\n            .eq('clinic_id', this.clinicId)\r\n            .order('created_at', { ascending: false });\r\n\r\n        if (error) {\r\n            console.error('Supabase Error (listByPatient):', error);\r\n            return [];\r\n        }\r\n\r\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n        return (data || []).map((d: any) => this.mapToClinicalEntry(d, d.profiles));\r\n    }\r\n\r\n    async findById(id: string): Promise<ClinicalEntry | null> {\r\n        const { data, error } = await this.supabase\r\n            .from('clinical_entries')\r\n            .select('*')\r\n            .eq('id', id)\r\n            .eq('clinic_id', this.clinicId)\r\n            .maybeSingle();\r\n\r\n        if (error) {\r\n            console.error('Supabase Error (findById):', error);\r\n            return null;\r\n        }\r\n\r\n        return data ? this.mapToClinicalEntry(data) : null;\r\n    }\r\n\r\n    async findByConsultation(consultationId: string): Promise<ClinicalEntry | null> {\r\n        const { data, error } = await this.supabase\r\n            .from('clinical_entries')\r\n            .select('*')\r\n            .eq('consultation_id', consultationId)\r\n            .eq('clinic_id', this.clinicId)\r\n            .maybeSingle();\r\n\r\n        if (error) {\r\n            console.error('Supabase Error (findByConsultation):', error);\r\n            return null;\r\n        }\r\n\r\n        return data ? this.mapToClinicalEntry(data) : null;\r\n    }\r\n\r\n    async upsert(input: ClinicalEntryInput & { id?: string, clinicId: string }): Promise<ClinicalEntry> {\r\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n        const payload: any = {\r\n            consultation_id: input.consultationId,\r\n            patient_id: input.patientId,\r\n            doctor_user_id: input.doctorUserId,\r\n            clinic_id: input.clinicId,\r\n            chief_complaint: input.chiefComplaint,\r\n            diagnosis: input.diagnosis,\r\n            conduct: input.conduct,\r\n            observations: input.observations,\r\n            free_notes: input.freeNotes,\r\n            is_final: input.isFinal,\r\n            updated_at: new Date().toISOString()\r\n        };\r\n\r\n        if (input.id) {\r\n            payload.id = input.id;\r\n        }\r\n\r\n        const { data, error } = await this.supabase\r\n            .from('clinical_entries')\r\n            .upsert(payload)\r\n            .select()\r\n            .single();\r\n\r\n        if (error) {\r\n            console.error('Supabase Error (upsert clinical_entry):', error);\r\n            throw new Error(error.message || 'Failed to safe clinical entry');\r\n        }\r\n\r\n        return this.mapToClinicalEntry(data);\r\n    }\r\n\r\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n    private mapToClinicalEntry(row: any, _profiles?: any): ClinicalEntry {\r\n        return {\r\n            id: row.id,\r\n            consultationId: row.consultation_id,\r\n            patientId: row.patient_id,\r\n            doctorUserId: row.doctor_user_id,\r\n            clinicId: row.clinic_id,\r\n            chiefComplaint: row.chief_complaint,\r\n            diagnosis: row.diagnosis,\r\n            conduct: row.conduct,\r\n            observations: row.observations,\r\n            freeNotes: row.free_notes,\r\n            isFinal: row.is_final,\r\n            createdAt: row.created_at,\r\n            updatedAt: row.updated_at,\r\n        };\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\features\\consultation\\repository.clinical.types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\features\\consultation\\repository.mock.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\features\\consultation\\repository.supabase.ts","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":102,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":102,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3418,3421],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3418,3421],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\features\\consultation\\repository.types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\features\\consultation\\service.clinical.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\features\\consultation\\service.documents.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\features\\consultation\\service.summary.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\features\\consultation\\service.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'doctorId' is defined but never used.","line":45,"column":57,"nodeType":"Identifier","messageId":"unusedVar","endLine":45,"endColumn":65},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'doctorId' is defined but never used.","line":51,"column":37,"nodeType":"Identifier","messageId":"unusedVar","endLine":51,"endColumn":45}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Consultation, ConsultationInput } from './types';\r\nimport { IConsultationRepository } from './repository.types';\r\nimport { MockConsultationRepository } from './repository.mock';\r\nimport { SupabaseConsultationRepository } from './repository.supabase';\r\nimport { getCurrentUser } from '@/lib/session';\r\nimport { createClient } from '@/lib/supabase-auth';\r\nimport { supabaseServer } from '@/lib/supabase-server';\r\n\r\nconst getRepository = async (): Promise<IConsultationRepository> => {\r\n    const useSupabase = process.env.USE_SUPABASE === 'true';\r\n\r\n    if (useSupabase) {\r\n        const user = await getCurrentUser();\r\n        const authMode = process.env.AUTH_MODE || 'stub';\r\n        const defaultClinicId = '550e8400-e29b-41d4-a716-446655440000';\r\n        const clinicId = user?.clinicId || defaultClinicId;\r\n\r\n        if (authMode === 'supabase' && user) {\r\n            const client = await createClient();\r\n            return new SupabaseConsultationRepository(client, clinicId);\r\n        }\r\n\r\n        return new SupabaseConsultationRepository(supabaseServer, clinicId);\r\n    }\r\n\r\n    return new MockConsultationRepository();\r\n};\r\n\r\nexport class ConsultationService {\r\n    static async start(input: ConsultationInput): Promise<Consultation> {\r\n        const repo = await getRepository();\r\n        return repo.start(input);\r\n    }\r\n\r\n    static async getActiveByDoctor(doctorId: string): Promise<Consultation | undefined> {\r\n        const repo = await getRepository();\r\n        return repo.getActiveByDoctor(doctorId);\r\n    }\r\n\r\n    static async findById(id: string): Promise<Consultation | undefined> {\r\n        const repo = await getRepository();\r\n        return repo.findById(id);\r\n    }\r\n\r\n    static async updateNotes(id: string, notes: string, doctorId: string): Promise<void> {\r\n        const repo = await getRepository();\r\n        // Repository currently doesn't take doctorId, but we pass it for future-proofing/signature match\r\n        return repo.updateNotes(id, notes);\r\n    }\r\n\r\n    static async finish(id: string, doctorId: string): Promise<void> {\r\n        const repo = await getRepository();\r\n        return repo.finish(id);\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\features\\consultation\\types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\features\\doctors\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\features\\doctors\\repository.supabase.ts","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":28,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":28,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[989,992],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[989,992],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":71,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":71,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2494,2497],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2494,2497],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":96,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":96,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3525,3528],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3525,3528],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\features\\doctors\\repository.types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\features\\doctors\\service.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\features\\doctors\\types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\features\\patients\\__tests__\\service.test.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'beforeEach' is defined but never used.","line":1,"column":32,"nodeType":"Identifier","messageId":"unusedVar","endLine":1,"endColumn":42,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"beforeEach"},"fix":{"range":[29,41],"text":""},"desc":"Remove unused variable \"beforeEach\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { describe, it, expect, beforeEach } from 'vitest';\r\nimport { PatientService } from '../service';\r\n\r\ndescribe('PatientService', () => {\r\n    it('should list all initial mock patients', async () => {\r\n        const patients = await PatientService.list();\r\n        expect(patients.length).toBeGreaterThan(0);\r\n    });\r\n\r\n    it('should search patients by name', async () => {\r\n        const results = await PatientService.list('John');\r\n        expect(results).toHaveLength(1);\r\n        expect(results[0].name).toContain('John');\r\n    });\r\n\r\n    it('should create a new patient', async () => {\r\n        const input = {\r\n            name: 'Test Patient',\r\n            document: '00000000000',\r\n            phone: '11999999999',\r\n            birthDate: '2000-01-01'\r\n        };\r\n        const newPatient = await PatientService.create(input);\r\n        expect(newPatient.id).toBeDefined();\r\n        expect(newPatient.name).toBe(input.name);\r\n\r\n        // Verify it is in the list\r\n        const list = await PatientService.list();\r\n        expect(list).toContainEqual(newPatient);\r\n    });\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\features\\patients\\actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\features\\patients\\components\\PatientForm.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nE:\\SDMED Sys\\features\\patients\\components\\PatientForm.tsx:40:13\n  38 |     useEffect(() => {\n  39 |         if (currentStep === 3) {\n> 40 |             setIsSubmissionReady(false);\n     |             ^^^^^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  41 |             const timer = setTimeout(() => setIsSubmissionReady(true), 800);\n  42 |             return () => clearTimeout(timer);\n  43 |         }","line":40,"column":13,"nodeType":null,"endLine":40,"endColumn":33}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { useActionState, useEffect, useState } from 'react';\r\nimport { createPatientAction } from '../actions';\r\nimport { Button } from '@/components/ui/Button';\r\nimport { Input } from '@/components/ui/Input';\r\nimport { Textarea } from '@/components/ui/Textarea';\r\nimport { Patient } from '../types';\r\nimport styles from '../styles/Patients.module.css';\r\n\r\nexport default function PatientForm({ onSuccess }: { onSuccess?: (patient: Patient) => void }) {\r\n    const [state, formAction, isPending] = useActionState(createPatientAction, { error: '' });\r\n\r\n    // Wizard State\r\n    const [currentStep, setCurrentStep] = useState(1);\r\n    const [formData, setFormData] = useState({\r\n        name: '',\r\n        document: '',\r\n        birthDate: '',\r\n        guardian_name: '',\r\n        phone: '',\r\n        email: '',\r\n        // Address parts\r\n        address_zip: '',\r\n        address_street: '',\r\n        address_number: '',\r\n        address_neighborhood: '',\r\n        address_city: '',\r\n        // Clinical\r\n        insurance: '',\r\n        emergency_contact: '',\r\n        main_complaint: ''\r\n    });\r\n\r\n    // Safety state to prevent double-click \"Next\" -> \"Finish\" race condition\r\n    const [isSubmissionReady, setIsSubmissionReady] = useState(false);\r\n\r\n    useEffect(() => {\r\n        if (currentStep === 3) {\r\n            setIsSubmissionReady(false);\r\n            const timer = setTimeout(() => setIsSubmissionReady(true), 800);\r\n            return () => clearTimeout(timer);\r\n        }\r\n    }, [currentStep]);\r\n\r\n    useEffect(() => {\r\n        if (state?.success && state?.patient) {\r\n            if (onSuccess) onSuccess(state.patient);\r\n        }\r\n    }, [state?.success, state?.patient, onSuccess]);\r\n\r\n    // Reverted debug alert: This useEffect block was redundant and contained a debug alert.\r\n    // The first useEffect block already handles the success state correctly by calling onSuccess.\r\n\r\n    const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>) => {\r\n        const { name, value } = e.target;\r\n        setFormData(prev => ({ ...prev, [name]: value }));\r\n    };\r\n\r\n    const validateStep = (step: number) => {\r\n        if (step === 1) {\r\n            if (!formData.name || !formData.document || !formData.birthDate) {\r\n                alert('Por favor, preencha os campos obrigatórios (Nome, Documento e Data de Nascimento).');\r\n                return false;\r\n            }\r\n        }\r\n        if (step === 2) {\r\n            if (!formData.phone) {\r\n                alert('Por favor, informe ao menos um telefone de contato.');\r\n                return false;\r\n            }\r\n            if (formData.address_street && (!formData.address_city || !formData.address_neighborhood)) {\r\n                alert('Se preencher o endereço, informe ao menos a Rua, Bairro e Cidade.');\r\n                return false;\r\n            }\r\n        }\r\n        return true;\r\n    };\r\n\r\n    const handleNext = () => {\r\n        if (validateStep(currentStep)) {\r\n            setCurrentStep(prev => prev + 1);\r\n            window.scrollTo({ top: 0, behavior: 'smooth' });\r\n        }\r\n    };\r\n\r\n    const handleBack = () => {\r\n        setCurrentStep(prev => prev - 1);\r\n    };\r\n\r\n    // Helper to construct the full address for hidden input\r\n    const fullAddress = [\r\n        formData.address_street,\r\n        formData.address_number ? `nº ${formData.address_number}` : '',\r\n        formData.address_neighborhood ? `- ${formData.address_neighborhood}` : '',\r\n        formData.address_city ? `- ${formData.address_city}` : '',\r\n        formData.address_zip ? `(${formData.address_zip})` : ''\r\n    ].filter(Boolean).join(' ');\r\n\r\n    // Render helper for Steps\r\n    const renderStepIndicator = () => (\r\n        <div style={{ display: 'flex', justifyContent: 'center', marginBottom: '2rem', gap: '1rem' }}>\r\n            {[1, 2, 3].map(step => (\r\n                <div key={step} style={{\r\n                    display: 'flex', alignItems: 'center', gap: '0.5rem',\r\n                    opacity: currentStep === step ? 1 : 0.5,\r\n                    fontWeight: currentStep === step ? 'bold' : 'normal',\r\n                    color: currentStep === step ? 'var(--primary)' : '#999'\r\n                }}>\r\n                    <div style={{\r\n                        width: '28px', height: '28px', borderRadius: '50%',\r\n                        background: currentStep === step ? 'var(--primary)' : '#eee',\r\n                        color: currentStep === step ? '#fff' : '#666',\r\n                        display: 'flex', alignItems: 'center', justifyContent: 'center',\r\n                        fontSize: '0.875rem'\r\n                    }}>\r\n                        {step}\r\n                    </div>\r\n                    <span>\r\n                        {step === 1 && 'Dados Pessoais'}\r\n                        {step === 2 && 'Contato'}\r\n                        {step === 3 && 'Clínico'}\r\n                    </span>\r\n                </div>\r\n            ))}\r\n        </div>\r\n    );\r\n\r\n    return (\r\n        <div className={styles.formContainer}>\r\n            {renderStepIndicator()}\r\n\r\n            <form\r\n                autoComplete=\"off\"\r\n                onClick={(e) => e.stopPropagation()}\r\n                onSubmit={(e) => {\r\n                    e.preventDefault(); // ALWAYS prevent default browser submission\r\n\r\n                    const submitter = (e.nativeEvent as SubmitEvent).submitter as HTMLButtonElement | null;\r\n                    const isFinishButton = submitter?.id === 'btn-finish-registration';\r\n\r\n                    console.log('Submission Attempt:', {\r\n                        submitterId: submitter?.id,\r\n                        isFinishButton,\r\n                        currentStep\r\n                    });\r\n\r\n                    // Only allow submission IF:\r\n                    // 1. We are in Step 3 matches\r\n                    // 2. The submitter is explicitly the \"Finish\" button\r\n                    if (currentStep === 3 && isFinishButton) {\r\n                        console.log('Valid submission allowed.');\r\n                        const formData = new FormData(e.currentTarget);\r\n                        formAction(formData);\r\n                    } else {\r\n                        console.warn('Submission BLOCKED: Implicit submit or wrong step detected.');\r\n                        if (!isFinishButton) {\r\n                            console.warn('Reason: Submitter was not the finish button (likely implicit Enter or browser autofill).');\r\n                        }\r\n                    }\r\n                }}\r\n                onKeyDown={(e) => {\r\n                    if (e.key === 'Enter' && e.target instanceof HTMLInputElement) {\r\n                        e.preventDefault();\r\n                    }\r\n                }}>\r\n                <div style={{ display: 'flex', flexDirection: 'column', gap: '1.5rem' }}>\r\n\r\n                    {/* STEP 1: DADOS PESSOAIS */}\r\n                    {currentStep === 1 && (\r\n                        <div key=\"step1\">\r\n                            <h3 style={{ fontSize: '1.25rem', color: 'var(--primary)', marginBottom: '1.5rem', borderBottom: '2px solid #f0f0f0', paddingBottom: '0.5rem' }}>\r\n                                1. Dados Pessoais\r\n                            </h3>\r\n                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1.5rem' }}>\r\n                                <Input label=\"Nome Completo *\" name=\"name\" value={formData.name} onChange={handleChange} placeholder=\"Ex: João Silva\" fullWidth required />\r\n                                <Input label=\"Documento (CPF / RG) *\" name=\"document\" value={formData.document} onChange={handleChange} placeholder=\"000.000.000-00\" fullWidth required />\r\n                            </div>\r\n                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1.5rem', marginTop: '1.5rem' }}>\r\n                                <Input label=\"Data de Nascimento *\" name=\"birthDate\" type=\"date\" value={formData.birthDate} onChange={handleChange} fullWidth required />\r\n                                <Input label=\"Nome do Responsável\" name=\"guardian_name\" value={formData.guardian_name} onChange={handleChange} placeholder=\"Mãe, Pai ou Responsável\" fullWidth />\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n\r\n                    {/* STEP 2: CONTATO E ENDEREÇO */}\r\n                    {currentStep === 2 && (\r\n                        <div key=\"step2\">\r\n                            <h3 style={{ fontSize: '1.25rem', color: 'var(--primary)', marginBottom: '1.5rem', borderBottom: '2px solid #f0f0f0', paddingBottom: '0.5rem' }}>\r\n                                2. Contato e Endereço\r\n                            </h3>\r\n                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1.5rem' }}>\r\n                                <Input label=\"Telefone / WhatsApp *\" name=\"phone\" value={formData.phone} onChange={handleChange} placeholder=\"(00) 00000-0000\" fullWidth required />\r\n                                <Input label=\"E-mail\" name=\"email\" type=\"email\" value={formData.email} onChange={handleChange} placeholder=\"exemplo@email.com\" fullWidth />\r\n                            </div>\r\n\r\n                            <div style={{ marginTop: '1.5rem', borderTop: '1px dashed #eee', paddingTop: '1.5rem' }}>\r\n                                <h4 style={{ margin: '0 0 1rem 0', fontSize: '0.9rem', color: '#666', textTransform: 'uppercase' }}>Endereço Residencial</h4>\r\n\r\n                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 3fr', gap: '1rem', marginBottom: '1rem' }}>\r\n                                    <Input label=\"CEP\" name=\"address_zip\" value={formData.address_zip} onChange={handleChange} placeholder=\"00000-000\" fullWidth />\r\n                                    <Input label=\"Cidade / UF\" name=\"address_city\" value={formData.address_city} onChange={handleChange} placeholder=\"Ex: São Paulo - SP\" fullWidth />\r\n                                </div>\r\n\r\n                                <div style={{ display: 'grid', gridTemplateColumns: '3fr 1fr', gap: '1rem', marginBottom: '1rem' }}>\r\n                                    <Input label=\"Rua / Logradouro\" name=\"address_street\" value={formData.address_street} onChange={handleChange} placeholder=\"Ex: Av. Paulista\" fullWidth />\r\n                                    <Input label=\"Número\" name=\"address_number\" value={formData.address_number} onChange={handleChange} placeholder=\"123\" fullWidth />\r\n                                </div>\r\n\r\n                                <div>\r\n                                    <Input label=\"Bairro\" name=\"address_neighborhood\" value={formData.address_neighborhood} onChange={handleChange} placeholder=\"Ex: Bela Vista\" fullWidth />\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n\r\n                    {/* STEP 3: DADOS CLÍNICOS E FINANCEIROS */}\r\n                    {currentStep === 3 && (\r\n                        <div key=\"step3\">\r\n                            <h3 style={{ fontSize: '1.25rem', color: 'var(--primary)', marginBottom: '1.5rem', borderBottom: '2px solid #f0f0f0', paddingBottom: '0.5rem' }}>\r\n                                3. Dados Clínicos e Financeiros\r\n                            </h3>\r\n                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1.5rem' }}>\r\n                                <Input label=\"Convênio / Pagamento\" name=\"insurance\" value={formData.insurance} onChange={handleChange} placeholder=\"Ex: Unimed, Particular, etc.\" fullWidth />\r\n                                <Input label=\"Contato de Emergência\" name=\"emergency_contact\" value={formData.emergency_contact} onChange={handleChange} placeholder=\"Nome e Telefone\" fullWidth />\r\n                            </div>\r\n                            <div style={{ marginTop: '1.5rem' }}>\r\n                                <Textarea label=\"Queixa Principal / Motivo\" name=\"main_complaint\" value={formData.main_complaint} onChange={handleChange} placeholder=\"Motivo do cadastro ou queixa inicial\" fullWidth />\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n\r\n                    {/* HIDDEN INPUTS FOR PERSISTENCE across steps */}\r\n                    {/* Ensure 'address' is sent as a concatenated string */}\r\n                    <input type=\"hidden\" name=\"address\" value={fullAddress} />\r\n\r\n                    {Object.entries(formData).map(([key, value]) => {\r\n                        // Only render hidden input if the field is NOT in the current step logic\r\n                        // Strategy: Render hidden for fields NOT present in the current step.\r\n\r\n                        const step1Fields = ['name', 'document', 'birthDate', 'guardian_name'];\r\n                        const step2Fields = ['phone', 'email', 'address_zip', 'address_street', 'address_number', 'address_neighborhood', 'address_city'];\r\n                        const step3Fields = ['insurance', 'emergency_contact', 'main_complaint'];\r\n\r\n                        // We also skip individual address parts because we send the combined 'address' field\r\n                        const addressParts = ['address_zip', 'address_street', 'address_number', 'address_neighborhood', 'address_city'];\r\n                        if (addressParts.includes(key)) return null;\r\n\r\n                        let isVisible = false;\r\n                        if (currentStep === 1 && step1Fields.includes(key)) isVisible = true;\r\n                        if (currentStep === 2 && step2Fields.includes(key)) isVisible = true;\r\n                        if (currentStep === 3 && step3Fields.includes(key)) isVisible = true;\r\n\r\n                        if (!isVisible) {\r\n                            return <input key={key} type=\"hidden\" name={key} value={value} />;\r\n                        }\r\n                        return null;\r\n                    })}\r\n\r\n                    {/* NAVIGATION BUTTONS */}\r\n                    <div style={{ display: 'flex', justifyContent: 'space-between', marginTop: '2rem', paddingTop: '1rem', borderTop: '1px solid #eee' }}>\r\n                        {currentStep > 1 ? (\r\n                            <Button type=\"button\" variant=\"secondary\" onClick={handleBack}>\r\n                                Voltar\r\n                            </Button>\r\n                        ) : <div />} {/* Spacer */}\r\n\r\n                        {currentStep < 3 ? (\r\n                            <Button type=\"button\" variant=\"primary\" onClick={handleNext}>\r\n                                Próximo &gt;\r\n                            </Button>\r\n                        ) : (\r\n                            <Button\r\n                                id=\"btn-finish-registration\"\r\n                                type=\"submit\"\r\n                                variant=\"primary\"\r\n                                disabled={isPending || !isSubmissionReady}\r\n                                style={{\r\n                                    paddingLeft: '2rem',\r\n                                    paddingRight: '2rem',\r\n                                    backgroundColor: isSubmissionReady ? 'var(--success)' : '#ccc',\r\n                                    borderColor: isSubmissionReady ? 'var(--success)' : '#ccc',\r\n                                    cursor: isSubmissionReady ? 'pointer' : 'not-allowed'\r\n                                }}\r\n                            >\r\n                                {isPending ? 'Finalizando...' : 'Concluir Cadastro'}\r\n                            </Button>\r\n                        )}\r\n                    </div>\r\n\r\n                    {state?.error && (\r\n                        <div style={{\r\n                            padding: '0.75rem',\r\n                            backgroundColor: '#fee2e2',\r\n                            color: '#991b1b',\r\n                            borderRadius: '8px',\r\n                            fontSize: '0.875rem',\r\n                            marginTop: '1rem',\r\n                            border: '1px solid #fecaca',\r\n                            textAlign: 'center'\r\n                        }}>\r\n                            {state.error}\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            </form>\r\n        </div>\r\n    );\r\n}\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\features\\patients\\components\\PatientList.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\features\\patients\\components\\PatientModalWrapper.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\features\\patients\\components\\PatientOverview.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\features\\patients\\components\\PatientTimeline.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'index' is defined but never used.","line":22,"column":34,"nodeType":"Identifier","messageId":"unusedVar","endLine":22,"endColumn":39}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { ClinicalEntry } from '@/features/consultation/types';\r\nimport { Card } from '@/components/ui/Card';\r\nimport styles from './Timeline.module.css';\r\n\r\ninterface Props {\r\n    entries: ClinicalEntry[];\r\n}\r\n\r\nexport default function PatientTimeline({ entries }: Props) {\r\n    if (!entries || entries.length === 0) {\r\n        return (\r\n            <div style={{ textAlign: 'center', padding: '3rem', color: 'var(--text-muted)' }}>\r\n                Nenhum histórico clínico encontrado para este paciente.\r\n            </div>\r\n        );\r\n    }\r\n\r\n    return (\r\n        <div className={styles.timeline}>\r\n            {entries.map((entry, index) => (\r\n                <div key={entry.id} className={styles.timelineItem}>\r\n                    <div className={styles.marker}></div>\r\n                    <div className={styles.content}>\r\n                        <div className={styles.date}>\r\n                            {new Date(entry.createdAt).toLocaleDateString('pt-BR')} às {new Date(entry.createdAt).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}\r\n                        </div>\r\n                        <Card header={entry.chiefComplaint || 'Atendimento'}>\r\n                            <div className={styles.entryData}>\r\n                                {entry.diagnosis && (\r\n                                    <div className={styles.field}>\r\n                                        <span className={styles.fieldLabel}>Diagnóstico:</span>\r\n                                        <p>{entry.diagnosis}</p>\r\n                                    </div>\r\n                                )}\r\n                                {entry.conduct && (\r\n                                    <div className={styles.field}>\r\n                                        <span className={styles.fieldLabel}>Conduta:</span>\r\n                                        <p>{entry.conduct}</p>\r\n                                    </div>\r\n                                )}\r\n                                {entry.freeNotes && (\r\n                                    <div className={styles.field}>\r\n                                        <span className={styles.fieldLabel}>Evolução:</span>\r\n                                        <div className={styles.freeText}>{entry.freeNotes}</div>\r\n                                    </div>\r\n                                )}\r\n                                <div className={styles.entryFooter}>\r\n                                    <span>Médico ID: {entry.doctorUserId.slice(0, 8)}...</span>\r\n                                    {entry.isFinal && <span className={styles.finalBadge}>🔒 FINALIZADO</span>}\r\n                                </div>\r\n                            </div>\r\n                        </Card>\r\n                    </div>\r\n                </div>\r\n            ))}\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\features\\patients\\repository.mock.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\features\\patients\\repository.supabase.ts","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":38,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":38,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1270,1273],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1270,1273],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":120,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":120,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4220,4223],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4220,4223],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\features\\patients\\repository.types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\features\\patients\\service.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\features\\patients\\types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\features\\queue\\__tests__\\service.test.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'found' is assigned a value but never used.","line":44,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":44,"endColumn":20}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { describe, it, expect } from 'vitest';\r\nimport { QueueService } from '../service';\r\nimport { QueueItem } from '../types';\r\n\r\ndescribe('QueueService', () => {\r\n    let item: QueueItem;\r\n\r\n    it('should add item to queue and generate ticket code', async () => {\r\n        item = await QueueService.add({\r\n            patientId: 'test-patient-id',\r\n            status: 'WAITING'\r\n        }, 'SECRETARY');\r\n\r\n        expect(item.id).toBeDefined();\r\n        expect(item.ticketCode).toBeDefined();\r\n        expect(item.status).toBe('WAITING');\r\n    });\r\n\r\n    it('should allow valid transition WAITING -> CALLED', async () => {\r\n        const updated = await QueueService.changeStatus(item.id, 'CALLED', 'SECRETARY');\r\n        expect(updated.status).toBe('CALLED');\r\n    });\r\n\r\n    it('should allow valid transition CALLED -> IN_SERVICE', async () => {\r\n        const updated = await QueueService.changeStatus(item.id, 'IN_SERVICE', 'DOCTOR');\r\n        expect(updated.status).toBe('IN_SERVICE');\r\n    });\r\n\r\n    it('should allow valid transition IN_SERVICE -> DONE', async () => {\r\n        const updated = await QueueService.changeStatus(item.id, 'DONE', 'DOCTOR');\r\n        expect(updated.status).toBe('DONE');\r\n    });\r\n\r\n    it('should prevent invalid transition DONE -> WAITING', async () => {\r\n        await expect(QueueService.changeStatus(item.id, 'WAITING', 'SECRETARY'))\r\n            .rejects.toThrow('Invalid transition');\r\n    });\r\n\r\n    it('should mask data for TV list', async () => {\r\n        // Create a new waiting item\r\n        await QueueService.add({ patientId: 'secret-patient-id', status: 'WAITING' }, 'SECRETARY');\r\n\r\n        const tvList = await QueueService.getTVList();\r\n        const found = tvList.find(i => i.status === 'WAITING' && !i.patientName);\r\n        // Strategy changed: types definition says patientName exists, but getTVList returns Partial.\r\n        // Let's check if patientName is undefined in the returned partial objects or unchecked.\r\n        // Actually implementation of getTVList maps: { ticketCode, status, doctorId }. patientName is NOT mapped.\r\n\r\n        expect(tvList.some(i => i.patientName === undefined)).toBe(true);\r\n    });\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\features\\queue\\components\\DoctorQueue.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\features\\queue\\components\\QueuePanel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\features\\queue\\components\\TVBoard.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Clock' is defined but never used.","line":7,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":15,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Clock"},"fix":{"range":[218,224],"text":""},"desc":"Remove unused variable \"Clock\"."}]},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nE:\\SDMED Sys\\features\\queue\\components\\TVBoard.tsx:26:9\n  24 |\n  25 |     useEffect(() => {\n> 26 |         setMounted(true);\n     |         ^^^^^^^^^^ Avoid calling setState() directly within an effect\n  27 |\n  28 |         // Auto-refresh data\n  29 |         const interval = setInterval(() => {","line":26,"column":9,"nodeType":null,"endLine":26,"endColumn":19},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nE:\\SDMED Sys\\features\\queue\\components\\TVBoard.tsx:38:13\n  36 |     useEffect(() => {\n  37 |         if (currentCalled && currentCalled.id !== calling?.id) {\n> 38 |             setCalling(currentCalled);\n     |             ^^^^^^^^^^ Avoid calling setState() directly within an effect\n  39 |             const audio = new Audio('/notification.mp3');\n  40 |             audio.play().catch(() => { }); // Optional: notification sound\n  41 |","line":38,"column":13,"nodeType":null,"endLine":38,"endColumn":23}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { useEffect, useState } from 'react';\r\nimport { useRouter } from 'next/navigation';\r\nimport { QueueItemWithPatient } from '../types';\r\nimport styles from '../styles/Queue.module.css';\r\nimport { Clock, Building2, Activity, ArrowRight } from 'lucide-react';\r\n\r\nexport default function TVBoard({\r\n    items = [],\r\n    clinicName = 'SDMED SYS',\r\n    refreshSeconds = 30\r\n}: {\r\n    items?: Partial<QueueItemWithPatient>[],\r\n    clinicName?: string,\r\n    refreshSeconds?: number\r\n}) {\r\n    const router = useRouter();\r\n    const [calling, setCalling] = useState<Partial<QueueItemWithPatient> | null>(null);\r\n    const [mounted, setMounted] = useState(false);\r\n\r\n    // Identify CALLED item to ring/blink\r\n    const currentCalled = items.find(i => i.status === 'CALLED');\r\n\r\n    useEffect(() => {\r\n        setMounted(true);\r\n\r\n        // Auto-refresh data\r\n        const interval = setInterval(() => {\r\n            router.refresh();\r\n        }, refreshSeconds * 1000);\r\n\r\n        return () => clearInterval(interval);\r\n    }, [router, refreshSeconds]);\r\n\r\n    useEffect(() => {\r\n        if (currentCalled && currentCalled.id !== calling?.id) {\r\n            setCalling(currentCalled);\r\n            const audio = new Audio('/notification.mp3');\r\n            audio.play().catch(() => { }); // Optional: notification sound\r\n\r\n            const timer = setTimeout(() => setCalling(null), 5000);\r\n            return () => clearTimeout(timer);\r\n        }\r\n    }, [currentCalled, calling]);\r\n\r\n    const waiting = items.filter(i => i.status === 'WAITING').slice(0, 5);\r\n\r\n    return (\r\n        <div className={styles.tvContainer}>\r\n            <div className={styles.mainDisplay}>\r\n                <div className={styles.callingLabel}>\r\n                    <Activity size={32} />\r\n                    Chamando Agora\r\n                </div>\r\n                <div className={`${styles.ticketCard} ${calling ? styles.pulse : ''}`}>\r\n                    <div className={styles.ticketNumber}>{currentCalled?.ticketCode || '---'}</div>\r\n                    <div className={styles.patientName}>{currentCalled?.patientName || 'Aguardando...'}</div>\r\n                </div>\r\n            </div>\r\n\r\n            <aside className={styles.sideDisplay}>\r\n                <div className={styles.nextLabel}>Próximos</div>\r\n                <div className={styles.nextList}>\r\n                    {waiting.map(item => (\r\n                        <div key={item.id} className={styles.nextItem}>\r\n                            <span className={styles.nextTicket}>{item.ticketCode}</span>\r\n                            <div style={{ display: 'flex', alignItems: 'center', gap: '1rem' }}>\r\n                                <span className={styles.nextName}>{item.patientName}</span>\r\n                                <ArrowRight size={20} color=\"rgba(255,255,255,0.2)\" />\r\n                            </div>\r\n                        </div>\r\n                    ))}\r\n                    {waiting.length === 0 && (\r\n                        <div style={{ padding: '4rem 2rem', textAlign: 'center', opacity: 0.3, border: '2px dashed rgba(255,255,255,0.1)', borderRadius: '16px' }}>\r\n                            Fila vazia\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            </aside>\r\n\r\n            <footer className={styles.tvFooter}>\r\n                <div className={styles.clinicName}>\r\n                    <Building2 size={24} color=\"var(--accent)\" />\r\n                    {clinicName}\r\n                </div>\r\n                <div className={styles.clock}>\r\n                    {mounted && new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}\r\n                </div>\r\n            </footer>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\features\\queue\\repository.mock.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'PatientService' is defined but never used.","line":3,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":24,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"PatientService"},"fix":{"range":[139,192],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"prefer-const","severity":2,"message":"'MOCK_QUEUE' is never reassigned. Use 'const' instead.","line":5,"column":5,"nodeType":"Identifier","messageId":"useConst","endLine":5,"endColumn":28,"fix":{"range":[196,229],"text":"const MOCK_QUEUE: QueueItem[] = [];"}},{"ruleId":"prefer-const","severity":2,"message":"'AUDIT_LOGS' is never reassigned. Use 'const' instead.","line":6,"column":5,"nodeType":"Identifier","messageId":"useConst","endLine":6,"endColumn":27,"fix":{"range":[231,263],"text":"const AUDIT_LOGS: AuditLog[] = [];"}}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":2,"fixableWarningCount":0,"source":"import { QueueItem, QueueItemWithPatient, QueueStatus, AuditLog } from './types';\r\nimport { IQueueRepository } from './repository.types';\r\nimport { PatientService } from '../patients/service';\r\n\r\nlet MOCK_QUEUE: QueueItem[] = [];\r\nlet AUDIT_LOGS: AuditLog[] = [];\r\n\r\nexport class MockQueueRepository implements IQueueRepository {\r\n    private isValidTransition(current: QueueStatus, next: QueueStatus): boolean {\r\n        const transitions: Record<QueueStatus, QueueStatus[]> = {\r\n            'WAITING': ['CALLED', 'CANCELED', 'NO_SHOW'],\r\n            'CALLED': ['IN_SERVICE', 'NO_SHOW', 'WAITING'],\r\n            'IN_SERVICE': ['DONE'],\r\n            'DONE': [],\r\n            'NO_SHOW': ['WAITING'],\r\n            'CANCELED': ['WAITING']\r\n        };\r\n        return transitions[current]?.includes(next) ?? false;\r\n    }\r\n\r\n    async list(doctorId?: string): Promise<QueueItem[]> {\r\n        await new Promise(resolve => setTimeout(resolve, 200));\r\n        let filtered = MOCK_QUEUE.filter(i => !['DONE', 'CANCELED'].includes(i.status));\r\n        if (doctorId) {\r\n            filtered = filtered.filter(i => (i.doctorId === doctorId || !i.doctorId));\r\n        }\r\n        return filtered;\r\n    }\r\n\r\n    async getTVList(): Promise<Partial<QueueItemWithPatient>[]> {\r\n        const active = MOCK_QUEUE.filter(i => ['WAITING', 'CALLED', 'IN_SERVICE'].includes(i.status));\r\n        return active.map(i => ({\r\n            ticketCode: i.ticketCode,\r\n            status: i.status,\r\n            doctorId: i.doctorId,\r\n        }));\r\n    }\r\n\r\n    async add(item: Omit<QueueItem, 'id' | 'createdAt' | 'updatedAt' | 'ticketCode'>, actorRole: string): Promise<QueueItem> {\r\n        const code = `A${(MOCK_QUEUE.length + 1).toString().padStart(3, '0')}`;\r\n        const newItem: QueueItem = {\r\n            ...item,\r\n            id: Math.random().toString(36).substring(7),\r\n            ticketCode: code,\r\n            createdAt: new Date().toISOString(),\r\n            updatedAt: new Date().toISOString(),\r\n        };\r\n        MOCK_QUEUE.push(newItem);\r\n        this.logAudit('ADD', actorRole, newItem.id, `Added ticket ${code} for patient ${item.patientId}`);\r\n        return newItem;\r\n    }\r\n\r\n    async changeStatus(id: string, newStatus: QueueStatus, actorRole: string): Promise<QueueItem> {\r\n        const index = MOCK_QUEUE.findIndex(q => q.id === id);\r\n        if (index === -1) throw new Error('Item not found');\r\n\r\n        const item = MOCK_QUEUE[index];\r\n\r\n        if (!this.isValidTransition(item.status, newStatus)) {\r\n            throw new Error(`Invalid transition from ${item.status} to ${newStatus}`);\r\n        }\r\n\r\n        MOCK_QUEUE[index] = {\r\n            ...item,\r\n            status: newStatus,\r\n            updatedAt: new Date().toISOString()\r\n        };\r\n\r\n        this.logAudit('CHANGE_STATUS', actorRole, id, `Changed to ${newStatus}`);\r\n        return MOCK_QUEUE[index];\r\n    }\r\n\r\n    private logAudit(action: string, role: string, itemId: string, details?: string) {\r\n        AUDIT_LOGS.push({\r\n            timestamp: new Date().toISOString(),\r\n            action,\r\n            actorRole: role,\r\n            itemId,\r\n            details\r\n        });\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\features\\queue\\repository.supabase.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'actorRole' is defined but never used.","line":89,"column":60,"nodeType":"Identifier","messageId":"unusedVar","endLine":89,"endColumn":69}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":47,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":47,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1716,1719],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1716,1719],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":110,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":110,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4000,4003],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4000,4003],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { SupabaseClient } from '@supabase/supabase-js';\r\nimport { QueueItem, QueueItemWithPatient, QueueStatus } from './types';\r\nimport { IQueueRepository } from './repository.types';\r\n\r\nexport class SupabaseQueueRepository implements IQueueRepository {\r\n    constructor(\r\n        private supabase: SupabaseClient,\r\n        private clinicId: string\r\n    ) { }\r\n\r\n    async list(doctorId?: string): Promise<QueueItem[]> {\r\n        let query = this.supabase\r\n            .from('queue_items')\r\n            .select('*')\r\n            .eq('clinic_id', this.clinicId)\r\n            .not('status', 'in', '(\"DONE\",\"CANCELED\")')\r\n            .order('created_at', { ascending: true });\r\n\r\n        if (doctorId) {\r\n            query = query.or(`doctor_id.eq.${doctorId},doctor_id.is.null`);\r\n        }\r\n\r\n        const { data, error } = await query;\r\n\r\n        if (error) {\r\n            console.error('Supabase Error (list queue):', error);\r\n            throw new Error('Failed to list queue items');\r\n        }\r\n\r\n        return data.map(this.mapToQueueItem);\r\n    }\r\n\r\n    async getTVList(): Promise<QueueItemWithPatient[]> {\r\n        const { data, error } = await this.supabase\r\n            .from('queue_items')\r\n            .select('id, ticket_code, status, doctor_id, patient_id, created_at, updated_at, patients(name)')\r\n            .eq('clinic_id', this.clinicId)\r\n            .in('status', ['WAITING', 'CALLED', 'IN_SERVICE'])\r\n            .order('updated_at', { ascending: false });\r\n\r\n        if (error) {\r\n            console.error('Supabase Error (TV list):', error);\r\n            return [];\r\n        }\r\n\r\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n        return (data || []).map((row: any) => ({\r\n            id: row.id,\r\n            ticketCode: row.ticket_code,\r\n            status: row.status,\r\n            doctorId: row.doctor_id,\r\n            patientId: row.patient_id,\r\n            patientName: row.patients?.name || '---',\r\n            createdAt: row.created_at,\r\n            updatedAt: row.updated_at\r\n        }));\r\n    }\r\n\r\n    async add(item: Omit<QueueItem, 'id' | 'createdAt' | 'updatedAt' | 'ticketCode'>, actorRole: string, prefix: string = 'A'): Promise<QueueItem> {\r\n        const { data: newId, error: rpcError } = await this.supabase.rpc('generate_queue_ticket', {\r\n            p_clinic_id: this.clinicId,\r\n            p_patient_id: item.patientId,\r\n            p_doctor_id: item.doctorId,\r\n            p_appointment_id: item.appointmentId,\r\n            p_status: item.status,\r\n            p_prefix: prefix\r\n        });\r\n\r\n        if (rpcError) {\r\n            console.error('Supabase RPC Error (add queue):', rpcError);\r\n            throw new Error('Failed to add queue item: ' + rpcError.message);\r\n        }\r\n\r\n        // Fetch the newly created record to return the full QueueItem\r\n        const { data, error } = await this.supabase\r\n            .from('queue_items')\r\n            .select('*')\r\n            .eq('id', newId)\r\n            .single();\r\n\r\n        if (error) {\r\n            console.error('Supabase Error (fetch new queue item):', error);\r\n            throw new Error('Failed to retrieve newly created queue item');\r\n        }\r\n\r\n        return this.mapToQueueItem(data);\r\n    }\r\n\r\n    async changeStatus(id: string, newStatus: QueueStatus, actorRole: string): Promise<QueueItem> {\r\n        const { data, error } = await this.supabase\r\n            .from('queue_items')\r\n            .update({\r\n                status: newStatus,\r\n                updated_at: new Date().toISOString()\r\n            })\r\n            .eq('id', id)\r\n            .eq('clinic_id', this.clinicId)\r\n            .select()\r\n            .single();\r\n\r\n        if (error) {\r\n            console.error('Supabase Error (changeStatus):', error);\r\n            throw new Error('Failed to update queue status');\r\n        }\r\n\r\n        return this.mapToQueueItem(data);\r\n    }\r\n\r\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n    private mapToQueueItem(row: any): QueueItem {\r\n        return {\r\n            id: row.id,\r\n            ticketCode: row.ticket_code,\r\n            appointmentId: row.appointment_id,\r\n            patientId: row.patient_id,\r\n            doctorId: row.doctor_id,\r\n            status: row.status,\r\n            createdAt: row.created_at,\r\n            updatedAt: row.updated_at,\r\n        };\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\features\\queue\\repository.types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\features\\queue\\service.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":66,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":66,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { QueueItem, QueueStatus, QueueItemWithPatient } from './types';\r\nimport { IQueueRepository } from './repository.types';\r\nimport { MockQueueRepository } from './repository.mock';\r\nimport { SupabaseQueueRepository } from './repository.supabase';\r\nimport { PatientService } from '../patients/service';\r\nimport { getCurrentUser } from '@/lib/session';\r\nimport { createClient } from '@/lib/supabase-auth';\r\nimport { supabaseServer } from '@/lib/supabase-server';\r\n\r\nconst getRepository = async (): Promise<IQueueRepository> => {\r\n    const useSupabase = process.env.USE_SUPABASE === 'true';\r\n\r\n    if (useSupabase) {\r\n        const user = await getCurrentUser();\r\n        const authMode = process.env.AUTH_MODE || 'stub';\r\n        const defaultClinicId = '550e8400-e29b-41d4-a716-446655440000';\r\n        const clinicId = user?.clinicId || defaultClinicId;\r\n\r\n        // Special case for TV: If accessing from TV, we might NOT have a session if it's public.\r\n        // But TV usually uses a PIN and the middleware handles session?\r\n        // Let's assume for now that if they are authenticated or have a PIN cookie, we can use the appropriate client.\r\n        // Actually, TV usually wants Service Role because it's a \"display\" with limited input.\r\n        // However, RLS Phase 2 policy allows Reading TV list for Anon? \r\n        // No, requirements say: \"Garantir que /tv continue público apenas via middleware PIN e que o endpoint de TV use um caminho server-side que não vaze nomes.\"\r\n\r\n        if (authMode === 'supabase' && user) {\r\n            const client = await createClient();\r\n            return new SupabaseQueueRepository(client, clinicId);\r\n        }\r\n\r\n        return new SupabaseQueueRepository(supabaseServer, clinicId);\r\n    }\r\n\r\n    return new MockQueueRepository();\r\n};\r\n\r\nexport class QueueService {\r\n    static async list(doctorId?: string): Promise<QueueItemWithPatient[]> {\r\n        const repo = await getRepository();\r\n        const items = await repo.list(doctorId);\r\n\r\n        const enriched: QueueItemWithPatient[] = [];\r\n        for (const item of items) {\r\n            const patient = await PatientService.findById(item.patientId);\r\n            enriched.push({\r\n                ...item,\r\n                patientName: patient ? patient.name : 'Unknown'\r\n            });\r\n        }\r\n        return enriched;\r\n    }\r\n\r\n    static async getTVList(): Promise<Partial<QueueItemWithPatient>[]> {\r\n        const repo = await getRepository();\r\n        return repo.getTVList();\r\n    }\r\n\r\n    static async add(item: Omit<QueueItem, 'id' | 'createdAt' | 'updatedAt' | 'ticketCode'>, actorRole: string): Promise<QueueItem> {\r\n        const repo = await getRepository();\r\n\r\n        let prefix = 'A';\r\n        try {\r\n            const { SettingsService } = await import('../admin/settings/service');\r\n            const settings = await SettingsService.get();\r\n            prefix = settings.queuePrefix;\r\n        } catch (e) {\r\n            console.warn('QueueService: Using default prefix A due to settings error');\r\n        }\r\n\r\n        return repo.add(item, actorRole, prefix);\r\n    }\r\n\r\n    static async changeStatus(id: string, newStatus: QueueStatus, actorRole: string): Promise<QueueItem> {\r\n        const repo = await getRepository();\r\n        return repo.changeStatus(id, newStatus, actorRole);\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\features\\queue\\types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\lib\\__tests__\\rbac.test.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Role' is defined but never used.","line":3,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":14,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"Role"},"fix":{"range":[118,152],"text":""},"desc":"Remove unused import declaration."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { describe, it, expect } from 'vitest';\r\nimport { isPathAuthorized, getAuthorizedHome } from '../rbac-rules';\r\nimport { Role } from '../session';\r\n\r\ndescribe('RBAC Logic', () => {\r\n    describe('isPathAuthorized', () => {\r\n        it('should allow ADMIN to access /admin', () => {\r\n            expect(isPathAuthorized('/admin/dashboard', 'ADMIN')).toBe(true);\r\n        });\r\n\r\n        it('should deny DOCTOR to access /admin', () => {\r\n            expect(isPathAuthorized('/admin/doctors', 'DOCTOR')).toBe(false);\r\n            expect(isPathAuthorized('/admin/patients', 'DOCTOR')).toBe(false);\r\n            expect(isPathAuthorized('/admin/settings', 'DOCTOR')).toBe(false);\r\n        });\r\n\r\n        it('should deny SECRETARY to access /admin', () => {\r\n            expect(isPathAuthorized('/admin/settings', 'SECRETARY')).toBe(false);\r\n            expect(isPathAuthorized('/admin/patients', 'SECRETARY')).toBe(false);\r\n        });\r\n\r\n        it('should allow everyone to access /patients', () => {\r\n            expect(isPathAuthorized('/patients', 'ADMIN')).toBe(true);\r\n            expect(isPathAuthorized('/patients', 'DOCTOR')).toBe(true);\r\n            expect(isPathAuthorized('/patients', 'SECRETARY')).toBe(true);\r\n            expect(isPathAuthorized('/patients/uuid-123', 'DOCTOR')).toBe(true);\r\n        });\r\n\r\n        it('should allow DOCTOR to access /doctor', () => {\r\n            expect(isPathAuthorized('/doctor/agenda', 'DOCTOR')).toBe(true);\r\n        });\r\n\r\n        it('should allow ADMIN to access /doctor', () => {\r\n            expect(isPathAuthorized('/doctor/queue', 'ADMIN')).toBe(true);\r\n        });\r\n\r\n        it('should deny SECRETARY to access /doctor', () => {\r\n            expect(isPathAuthorized('/doctor/consultation', 'SECRETARY')).toBe(false);\r\n        });\r\n\r\n        it('should allow SECRETARY to access /secretary', () => {\r\n            expect(isPathAuthorized('/secretary/agenda', 'SECRETARY')).toBe(true);\r\n        });\r\n\r\n        it('should allow ADMIN to access /secretary', () => {\r\n            expect(isPathAuthorized('/secretary/queue', 'ADMIN')).toBe(true);\r\n        });\r\n\r\n        it('should allow public access to unlisted paths', () => {\r\n            expect(isPathAuthorized('/login', 'SECRETARY')).toBe(true);\r\n            expect(isPathAuthorized('/unauthorized', 'DOCTOR')).toBe(true);\r\n        });\r\n\r\n        it('should allow ADMIN and SECRETARY to access /tv', () => {\r\n            expect(isPathAuthorized('/tv', 'ADMIN')).toBe(true);\r\n            expect(isPathAuthorized('/tv', 'SECRETARY')).toBe(true);\r\n        });\r\n    });\r\n\r\n    describe('getAuthorizedHome', () => {\r\n        it('should return correct home for ADMIN', () => {\r\n            expect(getAuthorizedHome('ADMIN')).toBe('/admin');\r\n        });\r\n\r\n        it('should return correct home for DOCTOR', () => {\r\n            expect(getAuthorizedHome('DOCTOR')).toBe('/doctor/agenda');\r\n        });\r\n\r\n        it('should return correct home for SECRETARY', () => {\r\n            expect(getAuthorizedHome('SECRETARY')).toBe('/secretary/agenda');\r\n        });\r\n    });\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\lib\\audit.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":15,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":15,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[664,667],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[664,667],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { supabaseServer } from './supabase-server';\r\nimport { getCurrentUser } from './session';\r\n\r\nexport type AuditAction = 'CREATE' | 'UPDATE' | 'DELETE' | 'STATUS_CHANGE' | 'LOGIN' | 'LOGIN_FAILURE' | 'LOGOUT' | 'ACCESS_DENIED' | 'FINALIZE' | 'GENERATE_DOCUMENT' | 'OTHER';\r\nexport type AuditEntity = 'PATIENT' | 'APPOINTMENT' | 'QUEUE' | 'CONSULTATION' | 'AUTH' | 'DOCTOR' | 'SETTINGS' | 'CLINICAL_ENTRY';\r\n\r\n/**\r\n * Records a critical action to the audit logs.\r\n * Sensitive data should be excluded from metadata.\r\n */\r\nexport async function logAudit(\r\n    action: AuditAction,\r\n    entity: AuditEntity,\r\n    entityId?: string,\r\n    metadata: Record<string, any> = {}\r\n) {\r\n    try {\r\n        const user = await getCurrentUser();\r\n\r\n        // Fallback or system default clinic\r\n        const clinicId = user?.clinicId || '550e8400-e29b-41d4-a716-446655440000';\r\n\r\n        const { error } = await supabaseServer\r\n            .from('audit_logs')\r\n            .insert([{\r\n                user_id: user?.id || null,\r\n                role: user?.role || 'SYSTEM',\r\n                action,\r\n                entity,\r\n                entity_id: entityId,\r\n                clinic_id: clinicId,\r\n                metadata,\r\n                created_at: new Date().toISOString()\r\n            }]);\r\n\r\n        if (error) {\r\n            console.error('Audit Logging Failed:', error);\r\n        }\r\n    } catch (err) {\r\n        console.error('Error in logAudit helper:', err);\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\lib\\nav.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\lib\\pdf\\generator.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\lib\\pdf\\templates.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\lib\\rbac-rules.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\lib\\session.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'supabaseServer' is defined but never used.","line":3,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":24,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"supabaseServer"},"fix":{"range":[94,149],"text":""},"desc":"Remove unused import declaration."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { cookies } from 'next/headers';\r\nimport { createClient } from '@/lib/supabase-auth';\r\nimport { supabaseServer } from '@/lib/supabase-server';\r\n\r\nimport { Role, UserSession } from './types/auth';\r\n\r\nexport { type Role, type UserSession };\r\n\r\n// 1. Stub Implementation (Original)\r\nasync function getStubUser(): Promise<UserSession | null> {\r\n    try {\r\n        const cookieStore = await cookies();\r\n        const mockRole = cookieStore.get('mock_role')?.value as Role | undefined;\r\n\r\n        const role: Role = mockRole || 'SECRETARY';\r\n        let id = 'u1';\r\n        let name = 'User';\r\n\r\n        if (role === 'DOCTOR') {\r\n            id = 'd5e044f1-ef68-4731-aebe-5a8afc8c15a9'; // Andre Maia (Valid UUID for testing)\r\n            name = 'Dr. House (Stub)';\r\n        } else if (role === 'ADMIN') {\r\n            id = 'admin';\r\n            name = 'Admin User';\r\n        }\r\n\r\n        return { id, name, role, email: 'stub@example.com' };\r\n    } catch (e) {\r\n        console.warn('Session: Failed to get stub user', e);\r\n        return null;\r\n    }\r\n}\r\n\r\n// 2. Supabase Implementation\r\nasync function getSupabaseUser(): Promise<UserSession | null> {\r\n    try {\r\n        const supabase = await createClient();\r\n        const { data: { user }, error } = await supabase.auth.getUser();\r\n\r\n        if (error || !user) {\r\n            return null; // Not logged in\r\n        }\r\n\r\n        // Fetch Profile to get Role\r\n        const { data: profile, error: profileError } = await supabase\r\n            .from('profiles')\r\n            .select('role, clinic_id, email')\r\n            .eq('id', user.id)\r\n            .maybeSingle(); // Use maybeSingle to avoid errors on missing profile\r\n\r\n        if (profileError || !profile) {\r\n            console.warn('Profile not found for user:', user.id);\r\n            return null;\r\n        }\r\n\r\n        return {\r\n            id: user.id,\r\n            name: user.email || 'Supabase User',\r\n            role: profile.role as Role,\r\n            clinicId: profile.clinic_id,\r\n            email: user.email\r\n        };\r\n    } catch (e) {\r\n        console.warn('Session: Failed to get supabase user', e);\r\n        return null;\r\n    }\r\n}\r\n\r\n// Main Factory\r\nexport async function getCurrentUser(): Promise<UserSession | null> {\r\n    const authMode = process.env.AUTH_MODE || 'stub';\r\n\r\n    if (authMode === 'supabase') {\r\n        return getSupabaseUser();\r\n    }\r\n\r\n    return getStubUser();\r\n}\r\n\r\nexport async function requireRole(allowedRoles: Role[]) {\r\n    const user = await getCurrentUser();\r\n    if (!user) {\r\n        throw new Error('Unauthorized: No active session');\r\n    }\r\n    if (!allowedRoles.includes(user.role)) {\r\n        throw new Error(`Forbidden: Role ${user.role} is not allowed. Required: ${allowedRoles.join(', ')}`);\r\n    }\r\n    return user;\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\lib\\supabase-auth.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":29,"column":30,"nodeType":"Identifier","messageId":"unusedVar","endLine":29,"endColumn":35},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":36,"column":30,"nodeType":"Identifier","messageId":"unusedVar","endLine":36,"endColumn":35}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createServerClient, type CookieOptions } from '@supabase/ssr';\r\nimport { cookies } from 'next/headers';\r\n\r\n// Server Client for Auth (handles Cookies)\r\nexport async function createClient() {\r\n    // Defensive check for Environment Variables to prevent crashing during SSR if missing\r\n    const url = process.env.NEXT_PUBLIC_SUPABASE_URL;\r\n    const key = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;\r\n\r\n    if (!url || !key) {\r\n        if (process.env.NODE_ENV === 'production') {\r\n            console.error('CRITICAL: Supabase environment variables are missing!');\r\n        }\r\n    }\r\n\r\n    const cookieStore = await cookies();\r\n\r\n    return createServerClient(\r\n        url || 'https://missing-url.supabase.co',\r\n        key || 'missing-key',\r\n        {\r\n            cookies: {\r\n                get(name: string) {\r\n                    return cookieStore.get(name)?.value;\r\n                },\r\n                set(name: string, value: string, options: CookieOptions) {\r\n                    try {\r\n                        cookieStore.set({ name, value, ...options });\r\n                    } catch (error) {\r\n                        // Safe to ignore in Server Components\r\n                    }\r\n                },\r\n                remove(name: string, options: CookieOptions) {\r\n                    try {\r\n                        cookieStore.set({ name, value: '', ...options });\r\n                    } catch (error) {\r\n                        // Safe to ignore in Server Components\r\n                    }\r\n                },\r\n            },\r\n        }\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\lib\\supabase-server.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\lib\\supabase.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\lib\\types\\auth.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\lib\\types\\server-actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\middleware.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\next.config.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\seed_users.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\vitest.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]