
> sdmed-sys@0.1.0 test
> vitest features/consultation


[1m[44m DEV [49m[22m [34mv4.0.18 [39m[90mE:/SDMED Sys[39m

[90mstderr[2m | features/consultation/__tests__/repository.clinical.test.ts[2m > [22m[2mSupabaseClinicalEntryRepository[2m > [22m[2mshould return empty on error
[22m[39mSupabase Error (listByPatient): { message: [32m'DB Error'[39m }

 [32mâœ“[39m features/consultation/__tests__/repository.clinical.test.ts [2m([22m[2m5 tests[22m[2m)[22m[32m 10[2mms[22m[39m
[90mstderr[2m | features/consultation/__tests__/documents.test.ts[2m > [22m[2mClinicalDocumentService (RBAC)[2m > [22m[2mshould allow DOCTOR only if owner
[22m[39mDocumentService: Doctor attempted to access another doctors consultation

 [32mâœ“[39m features/consultation/__tests__/documents.test.ts [2m([22m[2m3 tests[22m[2m)[22m[32m 27[2mms[22m[39m
 [32mâœ“[39m features/consultation/__tests__/summary.test.ts [2m([22m[2m3 tests[22m[2m)[22m[32m 5[2mms[22m[39m
 [32mâœ“[39m features/consultation/__tests__/service.test.ts [2m([22m[2m1 test[22m[2m)[22m[32m 3[2mms[22m[39m

[2m Test Files [22m [1m[32m4 passed[39m[22m[90m (4)[39m
[2m      Tests [22m [1m[32m12 passed[39m[22m[90m (12)[39m
[2m   Start at [22m 14:05:44
[2m   Duration [22m 3.21s[2m (transform 259ms, setup 0ms, import 569ms, tests 45ms, environment 4.54s)[22m

[1m[42m PASS [49m[22m [32mWaiting for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mfeatures/consultation/repository.supabase.ts [22m[34mx1 [34m[39m
       [2m Filename pattern: [22m[34mfeatures/consultation[39m

 [32mâœ“[39m features/consultation/__tests__/summary.test.ts [2m([22m[2m3 tests[22m[2m)[22m[32m 5[2mms[22m[39m

[2m Test Files [22m [1m[32m1 passed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[32m3 passed[39m[22m[90m (3)[39m
[2m   Start at [22m 14:20:52
[2m   Duration [22m 219ms

[1m[42m PASS [49m[22m [32mWaiting for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mfeatures/consultation/__tests__/repository.supabase.test.ts [22m[34mx1 [34m[39m
       [2m Filename pattern: [22m[34mfeatures/consultation[39m

 [31mâ¯[39m features/consultation/__tests__/repository.supabase.test.ts [2m([22m[2m3 tests[22m[2m | [22m[31m3 failed[39m[2m)[22m[32m 49[2mms[22m[39m
[31m     [31mÃ—[31m should throw error if updateStructuredFields affects 0 rows[39m[32m 14[2mms[22m[39m
[31m     [31mÃ—[31m should throw error if finish affects 0 rows[39m[32m 3[2mms[22m[39m
[31m     [31mÃ—[31m should succeed if updateStructuredFields affects 1 row[39m[32m 29[2mms[22m[39m

[31mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39m[1m[41m Failed Tests 3 [49m[22m[31mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39m

[41m[1m FAIL [22m[49m features/consultation/__tests__/repository.supabase.test.ts[2m > [22mSupabaseConsultationRepository[2m > [22mshould throw error if updateStructuredFields affects 0 rows
[41m[1m FAIL [22m[49m features/consultation/__tests__/repository.supabase.test.ts[2m > [22mSupabaseConsultationRepository[2m > [22mshould throw error if finish affects 0 rows
[31m[1mAssertionError[22m: expected [Function] to throw error including 'Consultation not found or access deniâ€¦' but got 'this.supabase.from(...).update(...).eâ€¦'[39m

Expected: [32m"[7mConsultation[27m not f[7mo[27mun[7md or access denied[27m"[39m
Received: [31m"[7mthis.supabase.from(...).update(...).eq(...).eq is[27m not [7ma [27mfun[7mction[27m"[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[1/3]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m features/consultation/__tests__/repository.supabase.test.ts[2m > [22mSupabaseConsultationRepository[2m > [22mshould succeed if updateStructuredFields affects 1 row
[31m[1mAssertionError[22m: promise rejected "TypeError: this.supabase.from(...).updateâ€¦" instead of resolving[39m
[36m [2mâ¯[22m features/consultation/__tests__/repository.supabase.test.ts:[2m45:80[22m[39m
    [90m 43| [39m        mockEq[33m.[39m[34mmockResolvedValue[39m({ error[33m:[39m [35mnull[39m[33m,[39m count[33m:[39m [34m1[39m })[33m;[39m
    [90m 44| [39m
    [90m 45| [39m        await expect(repo.updateStructuredFields('id-1', { diagnosis: â€¦
    [90m   | [39m                                                                               [31m^[39m
    [90m 46| [39m            [33m.[39mresolves[33m.[39mnot[33m.[39m[34mtoThrow[39m()[33m;[39m
    [90m 47| [39m    })[33m;[39m

[31m[1mCaused by: TypeError[22m: this.supabase.from(...).update(...).eq(...).eq is not a function[39m
[36m [2mâ¯[22m SupabaseConsultationRepository.updateStructuredFields features/consultation/repository.supabase.ts:[2m80:14[22m[39m
[90m [2mâ¯[22m features/consultation/__tests__/repository.supabase.test.ts:[2m45:27[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[2/3]âŽ¯[22m[39m


[2m Test Files [22m [1m[31m1 failed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[31m3 failed[39m[22m[90m (3)[39m
[2m   Start at [22m 14:21:21
[2m   Duration [22m 107ms

[1m[41m FAIL [49m[22m [31mTests failed. Watching for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mfeatures/consultation/__tests__/repository.supabase.test.ts [22m[34mx2 [34m[39m
       [2m Filename pattern: [22m[34mfeatures/consultation[39m

 [31mâ¯[39m features/consultation/__tests__/repository.supabase.test.ts [2m([22m[2m3 tests[22m[2m | [22m[31m3 failed[39m[2m)[22m[32m 115[2mms[22m[39m
[31m     [31mÃ—[31m should throw error if updateStructuredFields affects 0 rows[39m[32m 73[2mms[22m[39m
[31m     [31mÃ—[31m should throw error if finish affects 0 rows[39m[32m 16[2mms[22m[39m
[31m     [31mÃ—[31m should succeed if updateStructuredFields affects 1 row[39m[32m 18[2mms[22m[39m

[31mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39m[1m[41m Failed Tests 3 [49m[22m[31mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39m

[41m[1m FAIL [22m[49m features/consultation/__tests__/repository.supabase.test.ts[2m > [22mSupabaseConsultationRepository[2m > [22mshould throw error if updateStructuredFields affects 0 rows
[41m[1m FAIL [22m[49m features/consultation/__tests__/repository.supabase.test.ts[2m > [22mSupabaseConsultationRepository[2m > [22mshould throw error if finish affects 0 rows
[31m[1mAssertionError[22m: expected [Function] to throw error including 'Consultation not found or access deniâ€¦' but got 'this.supabase.from(...).update(...).eâ€¦'[39m

Expected: [32m"[7mConsultation[27m not f[7mo[27mun[7md or access denied[27m"[39m
Received: [31m"[7mthis.supabase.from(...).update(...).eq(...).eq is[27m not [7ma [27mfun[7mction[27m"[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[1/3]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m features/consultation/__tests__/repository.supabase.test.ts[2m > [22mSupabaseConsultationRepository[2m > [22mshould succeed if updateStructuredFields affects 1 row
[31m[1mAssertionError[22m: promise rejected "TypeError: this.supabase.from(...).updateâ€¦" instead of resolving[39m
[36m [2mâ¯[22m features/consultation/__tests__/repository.supabase.test.ts:[2m45:80[22m[39m
    [90m 43| [39m        mockEq[33m.[39m[34mmockResolvedValue[39m({ error[33m:[39m [35mnull[39m[33m,[39m count[33m:[39m [34m1[39m })[33m;[39m
    [90m 44| [39m
    [90m 45| [39m        await expect(repo.updateStructuredFields('id-1', { diagnosis: â€¦
    [90m   | [39m                                                                               [31m^[39m
    [90m 46| [39m            [33m.[39mresolves[33m.[39mnot[33m.[39m[34mtoThrow[39m()[33m;[39m
    [90m 47| [39m    })[33m;[39m

[31m[1mCaused by: TypeError[22m: this.supabase.from(...).update(...).eq(...).eq is not a function[39m
[36m [2mâ¯[22m SupabaseConsultationRepository.updateStructuredFields features/consultation/repository.supabase.ts:[2m80:14[22m[39m
[90m [2mâ¯[22m features/consultation/__tests__/repository.supabase.test.ts:[2m45:27[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[2/3]âŽ¯[22m[39m


[2m Test Files [22m [1m[31m1 failed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[31m3 failed[39m[22m[90m (3)[39m
[2m   Start at [22m 14:21:24
[2m   Duration [22m 265ms

[1m[41m FAIL [49m[22m [31mTests failed. Watching for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mfeatures/consultation/__tests__/repository.supabase.test.ts [22m[34mx3 [34m[39m
       [2m Filename pattern: [22m[34mfeatures/consultation[39m

[90mstderr[2m | features/consultation/__tests__/repository.supabase.test.ts[2m > [22m[2mSupabaseConsultationRepository[2m > [22m[2mshould throw error if updateStructuredFields affects 0 rows
[22m[39mUpdate failed: Consultation id-1 not found or clinic mismatch (clinic-123)

[90mstderr[2m | features/consultation/__tests__/repository.supabase.test.ts[2m > [22m[2mSupabaseConsultationRepository[2m > [22m[2mshould throw error if finish affects 0 rows
[22m[39mFinish failed: Consultation id-1 not found or clinic mismatch (clinic-123)

 [32mâœ“[39m features/consultation/__tests__/repository.supabase.test.ts [2m([22m[2m3 tests[22m[2m)[22m[32m 39[2mms[22m[39m

[2m Test Files [22m [1m[32m1 passed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[32m3 passed[39m[22m[90m (3)[39m
[2m   Start at [22m 14:22:33
[2m   Duration [22m 191ms

[1m[42m PASS [49m[22m [32mWaiting for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
