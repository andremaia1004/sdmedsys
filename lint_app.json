[{"filePath":"E:\\SDMED Sys\\app\\(dashboard)\\SidebarNav.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\app\\(dashboard)\\admin\\audit\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":60,"column":90,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":60,"endColumn":93,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2817,2820],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2817,2820],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { fetchAuditLogsAction } from '@/app/actions/admin';\r\nimport { Card } from '@/components/ui/Card';\r\nimport { Table } from '@/components/ui/Table';\r\nimport { Badge } from '@/components/ui/Badge';\r\nimport { Button } from '@/components/ui/Button';\r\nimport Link from 'next/link';\r\n\r\nexport const dynamic = 'force-dynamic';\r\n\r\nexport default async function AuditPage(props: { searchParams: Promise<{ page?: string }> }) {\r\n    const searchParams = await props.searchParams;\r\n    const currentPage = parseInt(searchParams.page || '1');\r\n    const { logs, totalCount, totalPages } = await fetchAuditLogsAction(currentPage);\r\n\r\n    const getActionBadgeVariant = (action: string) => {\r\n        switch (action) {\r\n            case 'CREATE': return 'success';\r\n            case 'UPDATE': return 'warning';\r\n            case 'DELETE': return 'danger';\r\n            case 'STATUS_CHANGE': return 'primary';\r\n            default: return 'secondary';\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div style={{ padding: '1rem' }}>\r\n            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem' }}>\r\n                <div>\r\n                    <h1 style={{ margin: 0 }}>Logs de Auditoria</h1>\r\n                    <p style={{ color: 'var(--text-muted)', fontSize: '0.875rem' }}>Rastreabilidade de ações críticas do sistema</p>\r\n                </div>\r\n                <Link href=\"/admin\">\r\n                    <Button variant=\"ghost\">Voltar ao Dashboard</Button>\r\n                </Link>\r\n            </div>\r\n\r\n            <Card padding=\"none\">\r\n                <Table>\r\n                    <thead>\r\n                        <tr>\r\n                            <th>Data/Hora</th>\r\n                            <th>Usuário</th>\r\n                            <th>Ação</th>\r\n                            <th>Entidade</th>\r\n                            <th>ID Entidade</th>\r\n                            <th>Metadados</th>\r\n                        </tr>\r\n                    </thead>\r\n                    <tbody>\r\n                        {logs.map((log) => (\r\n                            <tr key={log.id}>\r\n                                <td style={{ fontSize: '0.8125rem', whiteSpace: 'nowrap' }}>\r\n                                    {new Date(log.created_at).toLocaleString('pt-BR')}\r\n                                </td>\r\n                                <td>\r\n                                    <div style={{ fontSize: '0.875rem', fontWeight: 500 }}>{log.role}</div>\r\n                                    <div style={{ fontSize: '0.75rem', color: 'var(--text-muted)' }}>{log.user_id?.substring(0, 8)}...</div>\r\n                                </td>\r\n                                <td>\r\n                                    <Badge variant={getActionBadgeVariant(log.action) as any}>\r\n                                        {log.action}\r\n                                    </Badge>\r\n                                </td>\r\n                                <td>\r\n                                    <span style={{ fontSize: '0.8125rem', fontWeight: 600, color: 'var(--text-main)' }}>\r\n                                        {log.entity}\r\n                                    </span>\r\n                                </td>\r\n                                <td style={{ fontSize: '0.75rem', color: 'var(--text-muted)', fontFamily: 'monospace' }}>\r\n                                    {log.entity_id || '-'}\r\n                                </td>\r\n                                <td>\r\n                                    <div style={{ fontSize: '0.75rem', maxWidth: '200px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>\r\n                                        {JSON.stringify(log.metadata)}\r\n                                    </div>\r\n                                </td>\r\n                            </tr>\r\n                        ))}\r\n                    </tbody>\r\n                </Table>\r\n\r\n                {logs.length === 0 && (\r\n                    <div style={{ padding: '3rem', textAlign: 'center', color: 'var(--text-muted)' }}>\r\n                        Nenhum log de auditoria encontrado.\r\n                    </div>\r\n                )}\r\n\r\n                <div style={{ padding: '1rem', borderTop: '1px solid var(--border)', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>\r\n                    <div style={{ fontSize: '0.8125rem', color: 'var(--text-muted)' }}>\r\n                        Total: <strong>{totalCount}</strong> logs\r\n                    </div>\r\n                    <div style={{ display: 'flex', gap: '0.5rem' }}>\r\n                        <Link href={`/admin/audit?page=${currentPage - 1}`} prefetch={false}>\r\n                            <Button variant=\"outline\" size=\"sm\" disabled={currentPage <= 1}>Anterior</Button>\r\n                        </Link>\r\n                        <div style={{ display: 'flex', alignItems: 'center', padding: '0 1rem', fontSize: '0.875rem' }}>\r\n                            Página {currentPage} de {totalPages}\r\n                        </div>\r\n                        <Link href={`/admin/audit?page=${currentPage + 1}`} prefetch={false}>\r\n                            <Button variant=\"outline\" size=\"sm\" disabled={currentPage >= totalPages}>Próxima</Button>\r\n                        </Link>\r\n                    </div>\r\n                </div>\r\n            </Card>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\app\\(dashboard)\\admin\\doctors\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Lock' is defined but never used.","line":11,"column":70,"nodeType":"Identifier","messageId":"unusedVar","endLine":11,"endColumn":74,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Lock"},"fix":{"range":[521,527],"text":""},"desc":"Remove unused variable \"Lock\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CheckCircle2' is defined but never used.","line":11,"column":89,"nodeType":"Identifier","messageId":"unusedVar","endLine":11,"endColumn":101,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"CheckCircle2"},"fix":{"range":[540,554],"text":""},"desc":"Remove unused variable \"CheckCircle2\"."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":83,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":83,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3011,3014],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3011,3014],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":123,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":123,"endColumn":21}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { useState, useEffect } from 'react';\r\nimport { Card } from '@/components/ui/Card';\r\nimport { Table } from '@/components/ui/Table';\r\nimport { Button } from '@/components/ui/Button';\r\nimport { Input } from '@/components/ui/Input';\r\nimport { Badge } from '@/components/ui/Badge';\r\nimport { fetchDoctorsAction, createDoctorAction, updateDoctorAction } from '@/app/actions/admin';\r\nimport { Doctor } from '@/features/doctors/types';\r\nimport { UserPlus, UserMinus, ShieldCheck, Mail, Phone, Hash, Award, Lock, Eye, EyeOff, CheckCircle2 } from 'lucide-react';\r\n\r\nexport default function DoctorsAdminPage() {\r\n    const [doctors, setDoctors] = useState<Doctor[]>([]);\r\n    const [loading, setLoading] = useState(true);\r\n    const [isSaving, setIsSaving] = useState(false);\r\n    const [showForm, setShowForm] = useState(false);\r\n    const [showPassword, setShowPassword] = useState(false);\r\n\r\n    // Form Stats\r\n    const [name, setName] = useState('');\r\n    const [specialty, setSpecialty] = useState('');\r\n    const [crm, setCrm] = useState('');\r\n    const [phone, setPhone] = useState('');\r\n    const [email, setEmail] = useState('');\r\n    const [password, setPassword] = useState('');\r\n    const [createAuth, setCreateAuth] = useState(true);\r\n\r\n    useEffect(() => {\r\n        loadDoctors();\r\n    }, []);\r\n\r\n    const loadDoctors = async () => {\r\n        setLoading(true);\r\n        try {\r\n            const data = await fetchDoctorsAction(false);\r\n            setDoctors(data);\r\n        } catch (err) {\r\n            console.error(err);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    const [isEditing, setIsEditing] = useState(false);\r\n    const [editingId, setEditingId] = useState<string | null>(null);\r\n\r\n    // ... (existing useEffect) ...\r\n\r\n    const handleSubmit = async (e: React.FormEvent) => {\r\n        e.preventDefault();\r\n        setIsSaving(true);\r\n        try {\r\n            const formData = new FormData();\r\n            formData.append('name', name);\r\n            formData.append('specialty', specialty);\r\n            formData.append('crm', crm);\r\n            formData.append('phone', phone);\r\n            formData.append('email', email);\r\n            if (password) formData.append('password', password);\r\n            formData.append('createAuth', createAuth.toString());\r\n\r\n            let res;\r\n            if (isEditing && editingId) {\r\n                res = await updateDoctorAction(editingId, {\r\n                    name,\r\n                    specialty,\r\n                    crm,\r\n                    phone,\r\n                    email,\r\n                    password: password || undefined\r\n                });\r\n            } else {\r\n                res = await createDoctorAction(formData);\r\n            }\r\n\r\n            if (res.success) {\r\n                resetForm();\r\n                await loadDoctors();\r\n            } else {\r\n                alert(res.error || 'Erro ao processar (sem detalhes)');\r\n            }\r\n        } catch (err: any) {\r\n            console.error(err);\r\n            alert(err.message || 'Erro inesperado na comunicação com o servidor');\r\n        } finally {\r\n            setIsSaving(false);\r\n        }\r\n    };\r\n\r\n    const resetForm = () => {\r\n        setName('');\r\n        setSpecialty('');\r\n        setCrm('');\r\n        setPhone('');\r\n        setEmail('');\r\n        setPassword('');\r\n        setIsEditing(false);\r\n        setEditingId(null);\r\n        setShowForm(false);\r\n        setCreateAuth(true);\r\n    };\r\n\r\n    const handleEdit = (doctor: Doctor) => {\r\n        setName(doctor.name);\r\n        setSpecialty(doctor.specialty || '');\r\n        setCrm(doctor.crm || '');\r\n        setPhone(doctor.phone || '');\r\n        setEmail(doctor.email || '');\r\n        setPassword(''); // Always blank for security, user enters only if changing\r\n        setCreateAuth(!!doctor.profileId);\r\n\r\n        setIsEditing(true);\r\n        setEditingId(doctor.id);\r\n        setShowForm(true);\r\n        window.scrollTo({ top: 0, behavior: 'smooth' });\r\n    };\r\n\r\n    const toggleActive = async (doctor: Doctor) => {\r\n        try {\r\n            await updateDoctorAction(doctor.id, { active: !doctor.active });\r\n            await loadDoctors();\r\n        } catch (err) {\r\n            alert('Erro ao atualizar status');\r\n        }\r\n    };\r\n\r\n    const generatePassword = () => {\r\n        const charset = \"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*\";\r\n        let retVal = \"\";\r\n        for (let i = 0, n = charset.length; i < 12; ++i) {\r\n            retVal += charset.charAt(Math.floor(Math.random() * n));\r\n        }\r\n        setPassword(retVal);\r\n        setShowPassword(true);\r\n    };\r\n\r\n    return (\r\n        <div style={{ padding: '2rem', maxWidth: '1200px', margin: '0 auto', animation: 'fadeIn 0.4s ease-out' }}>\r\n            <style jsx global>{`\r\n                @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }\r\n            `}</style>\r\n\r\n            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '2.5rem' }}>\r\n                <div>\r\n                    <h1 style={{ margin: 0, fontSize: '2rem', fontWeight: 850, color: 'var(--primary)', letterSpacing: '-0.02em' }}>\r\n                        Gestão de Profissionais\r\n                    </h1>\r\n                    <p style={{ color: 'var(--text-muted)', fontSize: '1rem', marginTop: '0.4rem', fontWeight: 500 }}>\r\n                        Controle central de acesso e dados dos médicos da clínica\r\n                    </p>\r\n                </div>\r\n                <Button\r\n                    variant={showForm ? 'secondary' : 'primary'}\r\n                    onClick={() => {\r\n                        if (showForm) resetForm();\r\n                        else setShowForm(true);\r\n                    }}\r\n                    style={{ borderRadius: '12px', padding: '0.75rem 1.5rem', fontWeight: 700, boxShadow: showForm ? 'none' : '0 4px 12px rgba(0, 45, 94, 0.2)' }}\r\n                >\r\n                    {showForm ? 'Cancelar' : (\r\n                        <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>\r\n                            <UserPlus size={18} />\r\n                            Novo Médico\r\n                        </div>\r\n                    )}\r\n                </Button>\r\n            </div>\r\n\r\n            {showForm && (\r\n                <Card\r\n                    style={{\r\n                        marginBottom: '2.5rem',\r\n                        border: 'none',\r\n                        boxShadow: '0 10px 40px rgba(0,0,0,0.08)',\r\n                        borderRadius: '20px',\r\n                        overflow: 'hidden'\r\n                    }}\r\n                >\r\n                    <div style={{ background: 'linear-gradient(135deg, var(--primary) 0%, #001f41 100%)', padding: '1.5rem 2rem', color: '#fff' }}>\r\n                        <h3 style={{ margin: 0, fontSize: '1.25rem', fontWeight: 800 }}>\r\n                            {isEditing ? 'Editar Médico' : 'Cadastrar Novo Médico'}\r\n                        </h3>\r\n                        <p style={{ margin: '0.25rem 0 0 0', opacity: 0.8, fontSize: '0.875rem' }}>\r\n                            {isEditing ? 'Atualize os dados ou altere a senha de acesso' : 'Preencha os dados e configure as credenciais de acesso'}\r\n                        </p>\r\n                    </div>\r\n\r\n                    <form onSubmit={handleSubmit} style={{ padding: '2rem', display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1.5rem' }}>\r\n                        {/* ... (First column: Personal Data - remains same) ... */}\r\n                        <div style={{ display: 'flex', flexDirection: 'column', gap: '1.5rem' }}>\r\n                            <div style={{ borderBottom: '1px solid var(--border)', paddingBottom: '0.5rem', marginBottom: '0.5rem' }}>\r\n                                <h4 style={{ margin: 0, fontSize: '0.875rem', color: 'var(--primary)', textTransform: 'uppercase', letterSpacing: '0.05em' }}>Dados Pessoais</h4>\r\n                            </div>\r\n                            <Input label=\"Nome Completo\" value={name} onChange={e => setName(e.target.value)} required placeholder=\"Ex: Dr. Roberto Silva\" />\r\n                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem' }}>\r\n                                <Input label=\"CRM\" value={crm} onChange={e => setCrm(e.target.value)} placeholder=\"000.000-UF\" />\r\n                                <Input label=\"Especialidade\" value={specialty} onChange={e => setSpecialty(e.target.value)} placeholder=\"Ex: Cardiologia\" />\r\n                            </div>\r\n                            <Input label=\"Celular\" value={phone} onChange={e => setPhone(e.target.value)} placeholder=\"(00) 00000-0000\" />\r\n                        </div>\r\n\r\n                        {/* ... (Second column: Credentials) ... */}\r\n                        <div style={{ display: 'flex', flexDirection: 'column', gap: '1.5rem' }}>\r\n                            <div style={{ borderBottom: '1px solid var(--border)', paddingBottom: '0.5rem', marginBottom: '0.5rem' }}>\r\n                                <h4 style={{ margin: 0, fontSize: '0.875rem', color: 'var(--primary)', textTransform: 'uppercase', letterSpacing: '0.05em' }}>Credenciais de Acesso</h4>\r\n                            </div>\r\n\r\n                            <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem', padding: '1rem', background: '#f8fafc', borderRadius: '12px', border: '1px solid var(--border)' }}>\r\n                                <input\r\n                                    type=\"checkbox\"\r\n                                    checked={createAuth}\r\n                                    onChange={e => setCreateAuth(e.target.checked)}\r\n                                    id=\"createAuth\"\r\n                                    disabled={isEditing && !!email} // Prevent unchecking if already has account\r\n                                    style={{ width: '18px', height: '18px', cursor: 'pointer' }}\r\n                                />\r\n                                <label htmlFor=\"createAuth\" style={{ fontWeight: 700, color: 'var(--primary)', cursor: 'pointer', fontSize: '0.9375rem' }}>\r\n                                    {isEditing ? 'Manter conta de acesso ativa' : 'Criar conta de acesso para este médico'}\r\n                                </label>\r\n                            </div>\r\n\r\n                            {createAuth && (\r\n                                <div style={{ display: 'flex', flexDirection: 'column', gap: '1.25rem', animation: 'fadeIn 0.2s ease-out' }}>\r\n                                    <Input\r\n                                        label=\"E-mail de Login\"\r\n                                        value={email}\r\n                                        onChange={e => setEmail(e.target.value)}\r\n                                        required\r\n                                        type=\"email\"\r\n                                        placeholder=\"medico@exemplo.com\"\r\n                                        disabled={isEditing} // Email is hard to change due to Auth linking\r\n                                    />\r\n                                    <div style={{ position: 'relative' }}>\r\n                                        <Input\r\n                                            label={isEditing ? \"Nova Senha (deixe em branco para manter)\" : \"Senha de Acesso\"}\r\n                                            value={password}\r\n                                            onChange={e => setPassword(e.target.value)}\r\n                                            required={!isEditing}\r\n                                            type={showPassword ? 'text' : 'password'}\r\n                                            placeholder={isEditing ? \"Nova senha...\" : \"Mínimo 6 caracteres\"}\r\n                                        />\r\n                                        <div style={{ position: 'absolute', right: '0.75rem', top: '2.3rem', display: 'flex', gap: '0.5rem' }}>\r\n                                            <button\r\n                                                type=\"button\"\r\n                                                onClick={() => setShowPassword(!showPassword)}\r\n                                                style={{ border: 'none', background: 'transparent', cursor: 'pointer', color: 'var(--text-muted)' }}\r\n                                            >\r\n                                                {showPassword ? <EyeOff size={18} /> : <Eye size={18} />}\r\n                                            </button>\r\n                                            <button\r\n                                                type=\"button\"\r\n                                                onClick={generatePassword}\r\n                                                style={{ border: 'none', background: 'transparent', cursor: 'pointer', color: 'var(--accent)', fontWeight: 700, fontSize: '0.75rem' }}\r\n                                            >\r\n                                                Gerar\r\n                                            </button>\r\n                                        </div>\r\n                                    </div>\r\n                                    <div style={{ fontSize: '0.75rem', color: 'var(--text-muted)', background: '#fffbeb', padding: '0.75rem', borderRadius: '8px', border: '1px solid #fef3c7' }}>\r\n                                        <strong>Atenção:</strong> {isEditing ? 'Se preenchida, a nova senha valerá imediatamente.' : 'Ao clicar em cadastrar, as credenciais serão ativadas imediatamente.'}\r\n                                    </div>\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n\r\n                        <div style={{ gridColumn: 'span 2', marginTop: '1rem', display: 'flex', justifyContent: 'flex-end' }}>\r\n                            <Button\r\n                                variant=\"primary\"\r\n                                type=\"submit\"\r\n                                disabled={isSaving}\r\n                                style={{ padding: '0.85rem 3rem', borderRadius: '12px', fontSize: '1rem', fontWeight: 800, background: 'var(--accent)' }}\r\n                            >\r\n                                {isSaving ? 'Processando...' : (isEditing ? 'Salvar Alterações' : 'Finalizar Cadastro Master')}\r\n                            </Button>\r\n                        </div>\r\n                    </form>\r\n                </Card>\r\n            )}\r\n\r\n            <Card padding=\"none\" style={{ borderRadius: '20px', border: 'none', boxShadow: '0 4px 20px rgba(0,0,0,0.05)', overflow: 'hidden' }}>\r\n                <Table headers={['Profissional', 'CRM / Especialidade', 'Contato', 'Status', 'Ações']}>\r\n                    {loading ? (\r\n                        <tr><td colSpan={5} style={{ textAlign: 'center', padding: '4rem' }}>\r\n                            <div style={{ color: 'var(--text-muted)' }}>Buscando base de médicos...</div>\r\n                        </td></tr>\r\n                    ) : doctors.length === 0 ? (\r\n                        <tr><td colSpan={5} style={{ textAlign: 'center', padding: '4rem' }}>Nenhum médico cadastrado.</td></tr>\r\n                    ) : doctors.map(doc => (\r\n                        <tr key={doc.id}>\r\n                            <td style={{ padding: '1.25rem' }}>\r\n                                <div style={{ display: 'flex', alignItems: 'center', gap: '1rem' }}>\r\n                                    <div style={{ width: '40px', height: '40px', borderRadius: '12px', background: 'var(--primary)', color: '#fff', display: 'flex', alignItems: 'center', justifyContent: 'center', fontWeight: 800 }}>\r\n                                        {doc.name.charAt(0).toUpperCase()}\r\n                                    </div>\r\n                                    <div>\r\n                                        <div style={{ fontWeight: 800, color: 'var(--primary)', fontSize: '1rem' }}>{doc.name}</div>\r\n                                        <div style={{ display: 'flex', alignItems: 'center', gap: '0.4rem', fontSize: '0.75rem', color: 'var(--text-muted)', marginTop: '0.1rem' }}>\r\n                                            {doc.profileId ? <ShieldCheck size={14} style={{ color: 'var(--success)' }} /> : <UserMinus size={14} />}\r\n                                            {doc.profileId ? 'Conta Vinculada' : 'Sem conta de acesso'}\r\n                                        </div>\r\n                                    </div>\r\n                                </div>\r\n                            </td>\r\n                            <td>\r\n                                <div>\r\n                                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.4rem', fontSize: '0.875rem', fontWeight: 700, color: 'var(--primary)' }}>\r\n                                        <Award size={14} /> {doc.specialty || 'Clínico'}\r\n                                    </div>\r\n                                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.4rem', fontSize: '0.75rem', color: 'var(--text-muted)', marginTop: '0.2rem' }}>\r\n                                        <Hash size={14} /> CRM: {doc.crm || '-'}\r\n                                    </div>\r\n                                </div>\r\n                            </td>\r\n                            <td>\r\n                                <div>\r\n                                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.4rem', fontSize: '0.8125rem', color: 'var(--text-muted)' }}>\r\n                                        <Mail size={14} /> {doc.email || '-'}\r\n                                    </div>\r\n                                    <div style={{ display: 'flex', alignItems: 'center', gap: '0.4rem', fontSize: '0.8125rem', color: 'var(--text-muted)', marginTop: '0.2rem' }}>\r\n                                        <Phone size={14} /> {doc.phone || '-'}\r\n                                    </div>\r\n                                </div>\r\n                            </td>\r\n                            <td>\r\n                                <Badge variant={doc.active ? 'success' : 'secondary'} style={{ padding: '0.4rem 0.8rem', borderRadius: '8px', fontWeight: 800 }}>\r\n                                    {doc.active ? 'ATIVO' : 'INATIVO'}\r\n                                </Badge>\r\n                            </td>\r\n                            <td>\r\n                                <div style={{ display: 'flex', gap: '0.5rem' }}>\r\n                                    <Button\r\n                                        variant=\"secondary\"\r\n                                        size=\"sm\"\r\n                                        onClick={() => handleEdit(doc)}\r\n                                        style={{ borderRadius: '8px', fontWeight: 700 }}\r\n                                    >\r\n                                        Editar\r\n                                    </Button>\r\n                                    <Button\r\n                                        variant={doc.active ? 'outline' : 'primary'}\r\n                                        size=\"sm\"\r\n                                        onClick={() => toggleActive(doc)}\r\n                                        style={{ borderRadius: '8px', fontWeight: 700 }}\r\n                                    >\r\n                                        {doc.active ? 'Desativar' : 'Ativar'}\r\n                                    </Button>\r\n                                </div>\r\n                            </td>\r\n                        </tr>\r\n                    ))}\r\n                </Table>\r\n            </Card>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\app\\(dashboard)\\admin\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\app\\(dashboard)\\admin\\settings\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":39,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":39,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { useState, useEffect } from 'react';\r\nimport { Card } from '@/components/ui/Card';\r\nimport { Button } from '@/components/ui/Button';\r\nimport { Input } from '@/components/ui/Input';\r\nimport { fetchSettingsAction, updateSettingsAction } from '@/app/actions/admin';\r\nimport { ClinicSettings } from '@/features/admin/settings/types';\r\n\r\nexport default function SettingsAdminPage() {\r\n    const [settings, setSettings] = useState<ClinicSettings | null>(null);\r\n    const [loading, setLoading] = useState(true);\r\n    const [isSaving, setIsSaving] = useState(false);\r\n\r\n    useEffect(() => {\r\n        loadSettings();\r\n    }, []);\r\n\r\n    const loadSettings = async () => {\r\n        setLoading(true);\r\n        try {\r\n            const data = await fetchSettingsAction();\r\n            setSettings(data);\r\n        } catch (err) {\r\n            console.error(err);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    const handleSave = async (e: React.FormEvent) => {\r\n        e.preventDefault();\r\n        if (!settings) return;\r\n\r\n        setIsSaving(true);\r\n        try {\r\n            await updateSettingsAction(settings);\r\n            alert('Configurações atualizadas com sucesso!');\r\n        } catch (err) {\r\n            alert('Erro ao atualizar configurações');\r\n        } finally {\r\n            setIsSaving(false);\r\n        }\r\n    };\r\n\r\n    if (loading) return <div style={{ padding: '2rem' }}>Carregando configurações...</div>;\r\n    if (!settings) return <div style={{ padding: '2rem' }}>Erro ao carregar configurações.</div>;\r\n\r\n    return (\r\n        <div style={{ padding: '1.5rem', maxWidth: '800px' }}>\r\n            <h1 style={{ marginBottom: '0.5rem' }}>Configurações da Clínica</h1>\r\n            <p style={{ color: 'var(--text-muted)', marginBottom: '2rem' }}>Ajuste os parâmetros globais do sistema</p>\r\n\r\n            <form onSubmit={handleSave}>\r\n                <Card header=\"Identificação e Geral\" style={{ marginBottom: '1.5rem' }}>\r\n                    <div style={{ padding: '1rem', display: 'flex', flexDirection: 'column', gap: '1.5rem' }}>\r\n                        <Input\r\n                            label=\"Nome da Clínica\"\r\n                            value={settings.clinicName}\r\n                            onChange={e => setSettings({ ...settings, clinicName: e.target.value })}\r\n                        />\r\n                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem' }}>\r\n                            <Input\r\n                                label=\"Duração Padrão da Consulta (minutos)\"\r\n                                type=\"number\"\r\n                                value={settings.appointmentDurationMinutes}\r\n                                onChange={e => setSettings({ ...settings, appointmentDurationMinutes: parseInt(e.target.value) })}\r\n                            />\r\n                            <Input\r\n                                label=\"Prefixo da Senha (Fila)\"\r\n                                value={settings.queuePrefix}\r\n                                onChange={e => setSettings({ ...settings, queuePrefix: e.target.value })}\r\n                            />\r\n                        </div>\r\n                    </div>\r\n                </Card>\r\n\r\n                <Card header=\"Painel de TV\" style={{ marginBottom: '2rem' }}>\r\n                    <div style={{ padding: '1rem' }}>\r\n                        <Input\r\n                            label=\"Intervalo de Atualização do Painel (segundos)\"\r\n                            type=\"number\"\r\n                            value={settings.tvRefreshSeconds}\r\n                            onChange={e => setSettings({ ...settings, tvRefreshSeconds: parseInt(e.target.value) })}\r\n                        />\r\n                    </div>\r\n                </Card>\r\n\r\n                <div style={{ display: 'flex', justifyContent: 'flex-end' }}>\r\n                    <Button variant=\"primary\" type=\"submit\" disabled={isSaving} style={{ width: '200px' }}>\r\n                        {isSaving ? 'Salvando...' : 'Salvar Alterações'}\r\n                    </Button>\r\n                </div>\r\n            </form>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\app\\(dashboard)\\doctor\\agenda\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\app\\(dashboard)\\doctor\\consultation\\[id]\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\app\\(dashboard)\\doctor\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\app\\(dashboard)\\doctor\\queue\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\app\\(dashboard)\\layout.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Link' is defined but never used.","line":3,"column":8,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":12,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"Link"},"fix":{"range":[43,72],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Role' is defined but never used.","line":5,"column":26,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":30,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Role"},"fix":{"range":[149,155],"text":""},"desc":"Remove unused variable \"Role\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Button' is defined but never used.","line":7,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":16,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"Button"},"fix":{"range":[224,272],"text":""},"desc":"Remove unused import declaration."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"export const dynamic = 'force-dynamic';\r\n\r\nimport Link from 'next/link';\r\nimport { logoutAction } from '@/app/actions/auth';\r\nimport { getCurrentUser, Role } from '@/lib/session';\r\nimport styles from './layout.module.css';\r\nimport { Button } from '@/components/ui/Button';\r\nimport { LogOut } from 'lucide-react';\r\n\r\nimport SidebarNav from './SidebarNav';\r\n\r\nexport default async function DashboardLayout({\r\n    children,\r\n}: {\r\n    children: React.ReactNode;\r\n}) {\r\n    const user = await getCurrentUser();\r\n    const role = user?.role || 'SECRETARY';\r\n\r\n    // Map roles to Portuguese\r\n    const roleMap: Record<string, string> = {\r\n        'ADMIN': 'Administrador',\r\n        'SECRETARY': 'Secretaria',\r\n        'DOCTOR': 'Médico'\r\n    };\r\n\r\n    return (\r\n        <div className={styles.layout}>\r\n            <aside className={styles.sidebar}>\r\n                <div className={styles.logoContainer}>\r\n                    <span className={styles.logoText}>SDMED<span className={styles.logoAccent}>SYS</span></span>\r\n                </div>\r\n\r\n                <SidebarNav role={role} />\r\n\r\n                <div className={styles.logoutContainer}>\r\n                    <form action={logoutAction}>\r\n                        <button type=\"submit\" className={styles.logoutButton}>\r\n                            <LogOut size={18} />\r\n                            <span>Sair do Sistema</span>\r\n                        </button>\r\n                    </form>\r\n                </div>\r\n            </aside>\r\n\r\n            <div className={styles.mainArea}>\r\n                <header className={styles.topbar}>\r\n                    <div className={styles.userInfo}>\r\n                        <div className={styles.userData}>\r\n                            <div className={styles.userName}>{user?.name || 'Usuário'}</div>\r\n                            <div className={styles.userRoleBadge}>{roleMap[role] || role}</div>\r\n                        </div>\r\n                        <div className={styles.userAvatar}>\r\n                            {(user?.name || 'U').charAt(0).toUpperCase()}\r\n                        </div>\r\n                    </div>\r\n                </header>\r\n\r\n                <main className={styles.content}>\r\n                    {children}\r\n                </main>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\app\\(dashboard)\\patients\\[id]\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\app\\(dashboard)\\patients\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\app\\(dashboard)\\secretary\\agenda\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\app\\(dashboard)\\secretary\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\app\\(dashboard)\\secretary\\queue\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\app\\actions\\admin.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":162,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":162,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6098,6101],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6098,6101],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":170,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":170,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6491,6494],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6491,6494],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":176,"column":60,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":176,"endColumn":63,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6743,6746],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6743,6746],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'password' is assigned a value but never used.","line":221,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":221,"endColumn":25},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":231,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":231,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9055,9058],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9055,9058],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":263,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":263,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10116,10119],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10116,10119],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use server';\r\n\r\nimport { supabaseServer } from '@/lib/supabase-server';\r\nimport { requireRole } from '@/lib/session';\r\nimport { revalidatePath } from 'next/cache';\r\n\r\n/**\r\n * Administrative action to link a Supabase Auth User with a Profile Role.\r\n * Only accessible by ADMINs.\r\n */\r\nexport async function createProfile(userId: string, email: string, role: 'ADMIN' | 'SECRETARY' | 'DOCTOR') {\r\n    await requireRole(['ADMIN']);\r\n\r\n    const { data, error } = await supabaseServer\r\n        .from('profiles')\r\n        .upsert({\r\n            id: userId,\r\n            email: email,\r\n            role: role,\r\n            updated_at: new Date().toISOString()\r\n        })\r\n        .select()\r\n        .single();\r\n\r\n    if (error) {\r\n        console.error('Error creating profile:', error);\r\n        throw new Error(`Failed to create profile: ${error.message}`);\r\n    }\r\n\r\n    return data;\r\n}\r\n\r\nexport async function fetchAuditLogsAction(page: number = 1, limit: number = 20) {\r\n    const user = await requireRole(['ADMIN']);\r\n    const start = (page - 1) * limit;\r\n    const end = start + limit - 1;\r\n\r\n    const { data, error, count } = await supabaseServer\r\n        .from('audit_logs')\r\n        .select('*', { count: 'exact' })\r\n        .eq('clinic_id', user.clinicId) // Only current clinic\r\n        .order('created_at', { ascending: false })\r\n        .range(start, end);\r\n\r\n    if (error) {\r\n        console.error('Error fetching audit logs:', error);\r\n        throw new Error('Failed to fetch audit logs');\r\n    }\r\n\r\n    return {\r\n        logs: data,\r\n        totalCount: count || 0,\r\n        page,\r\n        totalPages: Math.ceil((count || 0) / limit)\r\n    };\r\n}\r\n\r\n// --- Doctors Management ---\r\n\r\nexport async function fetchDoctorsAction(activeOnly: boolean = false) {\r\n    const user = await requireRole(['ADMIN', 'SECRETARY', 'DOCTOR']);\r\n    const { SupabaseDoctorsRepository } = await import('@/features/doctors/repository.supabase');\r\n\r\n    // Use Service Role to ensure we can read all doctors for the clinic, avoiding partial RLS visibility\r\n    const clinicId = user.clinicId || '550e8400-e29b-41d4-a716-446655440000';\r\n    const repo = new SupabaseDoctorsRepository(supabaseServer, clinicId);\r\n\r\n    return repo.list(activeOnly);\r\n}\r\n\r\nexport async function createDoctorAction(formData: FormData) {\r\n    try {\r\n        const user = await requireRole(['ADMIN']);\r\n        const { SupabaseDoctorsRepository } = await import('@/features/doctors/repository.supabase');\r\n        const { logAudit } = await import('@/lib/audit');\r\n\r\n        // Critical Check for Service Role Key and URL\r\n        const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\r\n        const serviceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\r\n\r\n        if (!supabaseUrl || supabaseUrl === 'https://placeholder.supabase.co') {\r\n            console.error('CRITICAL: NEXT_PUBLIC_SUPABASE_URL is missing or invalid');\r\n            return {\r\n                success: false,\r\n                error: 'Erro de Configuração: URL do Supabase inválida ou não definida. Verifique as configurações do projeto.'\r\n            };\r\n        }\r\n\r\n        if (!serviceKey) {\r\n            console.error('CRITICAL: SUPABASE_SERVICE_ROLE_KEY missing in environment variables');\r\n            return {\r\n                success: false,\r\n                error: 'Erro de Configuração: Chave de Serviço do Supabase não encontrada. Verifique as variáveis de ambiente no Vercel.'\r\n            };\r\n        }\r\n\r\n        const name = formData.get('name') as string;\r\n        const specialty = formData.get('specialty') as string;\r\n        const crm = formData.get('crm') as string || undefined;\r\n        const phone = formData.get('phone') as string || undefined;\r\n        const email = formData.get('email') as string || undefined;\r\n        const password = formData.get('password') as string || undefined;\r\n        const createAuth = formData.get('createAuth') === 'true';\r\n\r\n        let profileId: string | undefined = undefined;\r\n\r\n        // 1. Create Auth User if requested\r\n        if (createAuth && email && password) {\r\n            // Create user via Admin API (ignores confirmation)\r\n            const { data: authData, error: authError } = await supabaseServer.auth.admin.createUser({\r\n                email,\r\n                password,\r\n                email_confirm: true,\r\n                user_metadata: { name }\r\n            });\r\n\r\n            if (authError) {\r\n                console.error('Auth Error during doctor creation:', authError);\r\n                return { success: false, error: `Erro ao criar conta de acesso: ${authError.message}` };\r\n            }\r\n\r\n            profileId = authData.user.id;\r\n\r\n            // 2. Create Profile\r\n            const { error: profileError } = await supabaseServer\r\n                .from('profiles')\r\n                .upsert({\r\n                    id: profileId,\r\n                    email: email,\r\n                    role: 'DOCTOR',\r\n                    clinic_id: user.clinicId,\r\n                    updated_at: new Date().toISOString()\r\n                });\r\n\r\n            if (profileError) {\r\n                // Rollback Auth user\r\n                await supabaseServer.auth.admin.deleteUser(profileId);\r\n                return { success: false, error: `Erro ao criar perfil de acesso: ${profileError.message}` };\r\n            }\r\n        }\r\n\r\n        // 3. Create Doctor Record\r\n        try {\r\n            const clinicId = user.clinicId || '550e8400-e29b-41d4-a716-446655440000';\r\n            const repo = new SupabaseDoctorsRepository(supabaseServer, clinicId);\r\n            const doctor = await repo.create({\r\n                name,\r\n                specialty,\r\n                crm,\r\n                phone,\r\n                email,\r\n                profileId\r\n            });\r\n\r\n            await logAudit('CREATE', 'DOCTOR', doctor.id, { name, specialty, crm });\r\n\r\n            revalidatePath('/admin/doctors');\r\n            revalidatePath('/doctor/agenda');\r\n            revalidatePath('/secretary/agenda');\r\n\r\n            return { success: true, doctor };\r\n        } catch (dbError: any) {\r\n            // Rollback Auth user if it was created\r\n            if (profileId) {\r\n                await supabaseServer.auth.admin.deleteUser(profileId);\r\n                await supabaseServer.from('profiles').delete().eq('id', profileId);\r\n            }\r\n            return { success: false, error: `Erro ao salvar dados do médico: ${dbError.message}` };\r\n        }\r\n    } catch (err: any) {\r\n        console.error('Unexpected error in createDoctorAction:', err);\r\n        return { success: false, error: `Erro inesperado: ${err.message || 'Erro desconhecido'}` };\r\n    }\r\n}\r\n\r\nexport async function updateDoctorAction(id: string, data: any) {\r\n    try {\r\n        const user = await requireRole(['ADMIN']);\r\n        const { SupabaseDoctorsRepository } = await import('@/features/doctors/repository.supabase');\r\n        const { logAudit } = await import('@/lib/audit');\r\n\r\n        // Critical Check for Service Role Key\r\n        if (!process.env.SUPABASE_SERVICE_ROLE_KEY) {\r\n            return {\r\n                success: false,\r\n                error: 'Erro de Configuração: Chave de Serviço ausente.'\r\n            };\r\n        }\r\n\r\n        // 1. Check if we need to update password\r\n        if (data.password && data.password.length > 0) {\r\n            // We need the profileId. If it's not in 'data', we fetch the doctor first\r\n            let profileId = data.profileId;\r\n\r\n            if (!profileId) {\r\n                // Fetch doctor to get profileId\r\n                const clinicId = user.clinicId || '550e8400-e29b-41d4-a716-446655440000';\r\n                const tempRepo = new SupabaseDoctorsRepository(supabaseServer, clinicId);\r\n                const doctor = await tempRepo.findById(id);\r\n                profileId = doctor?.profileId;\r\n            }\r\n\r\n            if (profileId) {\r\n                const { error: authError } = await supabaseServer.auth.admin.updateUserById(\r\n                    profileId,\r\n                    { password: data.password }\r\n                );\r\n\r\n                if (authError) {\r\n                    console.error('Error updating password:', authError);\r\n                    return { success: false, error: `Erro ao atualizar senha: ${authError.message}` };\r\n                }\r\n            }\r\n        }\r\n\r\n        // 2. Update Doctor Record using Service Role\r\n        const clinicId = user.clinicId || '550e8400-e29b-41d4-a716-446655440000';\r\n        const repo = new SupabaseDoctorsRepository(supabaseServer, clinicId);\r\n\r\n        // Remove password from data before passing to repository as it's not a doctor field\r\n        const { password, ...doctorData } = data;\r\n\r\n        const doctor = await repo.update(id, doctorData);\r\n\r\n        await logAudit('UPDATE', 'DOCTOR', id, { active: data.active });\r\n\r\n        revalidatePath('/admin/doctors');\r\n        revalidatePath('/doctor/agenda');\r\n        revalidatePath('/secretary/agenda');\r\n        return { success: true, doctor };\r\n    } catch (err: any) {\r\n        console.error('Error in updateDoctorAction:', err);\r\n        return { success: false, error: err.message || 'Erro ao atualizar médico' };\r\n    }\r\n}\r\n\r\n// --- Clinic Settings ---\r\n\r\nimport { SupabaseSettingsRepository } from '@/features/admin/settings/repository.supabase';\r\n\r\nexport async function fetchSettingsAction() {\r\n    const user = await requireRole(['ADMIN', 'SECRETARY', 'DOCTOR']);\r\n    const clinicId = user.clinicId || '550e8400-e29b-41d4-a716-446655440000';\r\n    const repo = new SupabaseSettingsRepository(supabaseServer, clinicId);\r\n    const settings = await repo.get();\r\n\r\n    if (settings) return settings;\r\n\r\n    // Default fallback if no settings in DB\r\n    return {\r\n        id: 'default',\r\n        clinicId,\r\n        clinicName: 'SDMED SYS',\r\n        workingHours: {},\r\n        appointmentDurationMinutes: 30,\r\n        queuePrefix: 'A',\r\n        tvRefreshSeconds: 30,\r\n        createdAt: new Date().toISOString(),\r\n        updatedAt: new Date().toISOString()\r\n    };\r\n}\r\n\r\nexport async function updateSettingsAction(data: any) {\r\n    await requireRole(['ADMIN']);\r\n    const { SettingsService } = await import('@/features/admin/settings/service');\r\n    const { logAudit } = await import('@/lib/audit');\r\n\r\n    const settings = await SettingsService.update(data);\r\n    await logAudit('UPDATE', 'SETTINGS', settings.id, { clinicName: settings.clinicName });\r\n\r\n    revalidatePath('/admin/settings');\r\n    revalidatePath('/tv');\r\n    return { success: true, settings };\r\n}\r\n\r\n/**\r\n * Publicly accessible configurations for the TV panel.\r\n * Protected by PIN in middleware, but doesn't need a full User role.\r\n */\r\nexport async function fetchPublicSettingsAction() {\r\n    // TV panel uses default clinic for now\r\n    const clinicId = '550e8400-e29b-41d4-a716-446655440000';\r\n    const repo = new SupabaseSettingsRepository(supabaseServer, clinicId);\r\n    const settings = await repo.get();\r\n\r\n    if (settings) return settings;\r\n\r\n    return {\r\n        id: 'default',\r\n        clinicId,\r\n        clinicName: 'SDMED SYS',\r\n        workingHours: {},\r\n        appointmentDurationMinutes: 30,\r\n        queuePrefix: 'A',\r\n        tvRefreshSeconds: 30,\r\n        createdAt: new Date().toISOString(),\r\n        updatedAt: new Date().toISOString()\r\n    };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\app\\actions\\auth.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\app\\actions\\patients.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\app\\actions\\queue.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\app\\api\\documents\\[type]\\[id]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\app\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\app\\login\\page.tsx","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Use \"@ts-expect-error\" instead of \"@ts-ignore\", as \"@ts-ignore\" will do nothing if the following line is error-free.","line":16,"column":5,"nodeType":"Line","messageId":"tsIgnoreInsteadOfExpectError","endLine":16,"endColumn":48,"suggestions":[{"messageId":"replaceTsIgnoreWithTsExpectError","fix":{"range":[404,447],"text":"// @ts-expect-error - React 19 / Next.js 15 types"},"desc":"Replace \"@ts-ignore\" with \"@ts-expect-error\"."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { useActionState } from 'react';\r\nimport { loginAction } from '@/app/actions/auth';\r\nimport { Button } from '@/components/ui/Button';\r\nimport { Input } from '@/components/ui/Input';\r\nimport { Card } from '@/components/ui/Card';\r\nimport styles from './login.module.css';\r\n\r\nconst initialState = {\r\n    error: '',\r\n    message: '',\r\n};\r\n\r\nexport default function LoginPage() {\r\n    // @ts-ignore - React 19 / Next.js 15 types\r\n    const [state, formAction, isPending] = useActionState(loginAction, initialState);\r\n\r\n    return (\r\n        <div className={styles.page}>\r\n            <Card className={styles.loginCard} padding=\"lg\">\r\n                <div className={styles.header}>\r\n                    <h1 className={styles.title}>\r\n                        SDMED<span className={styles.titleAccent}>SYS</span>\r\n                    </h1>\r\n                    <p className={styles.subtitle}>Sistema de Gestão Médica</p>\r\n                </div>\r\n\r\n                <form action={formAction} className={styles.form}>\r\n                    <Input\r\n                        label=\"E-mail ou Usuário\"\r\n                        name=\"username\"\r\n                        type=\"text\"\r\n                        placeholder=\"admin@sdmed.com\"\r\n                        required\r\n                    />\r\n\r\n                    <Input\r\n                        label=\"Senha\"\r\n                        name=\"password\"\r\n                        type=\"password\"\r\n                        placeholder=\"••••••••\"\r\n                        required\r\n                    />\r\n\r\n                    <Button\r\n                        type=\"submit\"\r\n                        disabled={isPending}\r\n                        fullWidth\r\n                        size=\"lg\"\r\n                    >\r\n                        {isPending ? 'Entrando...' : 'Entrar'}\r\n                    </Button>\r\n\r\n                    {state?.error && (\r\n                        <div style={{\r\n                            padding: '0.75rem',\r\n                            backgroundColor: '#fee2e2',\r\n                            color: '#991b1b',\r\n                            borderRadius: '8px',\r\n                            fontSize: '0.875rem',\r\n                            textAlign: 'center',\r\n                            border: '1px solid #fecaca'\r\n                        }}>\r\n                            {state.error === 'Invalid login credentials' ? 'Credenciais de acesso inválidas' : state.error}\r\n                        </div>\r\n                    )}\r\n                </form>\r\n            </Card>\r\n\r\n            <div className={styles.hints}>\r\n                <p><strong>Modo de Teste (AUTH_MODE=stub)</strong></p>\r\n                <ul className={styles.hintList}>\r\n                    <li><code>admin</code> (Admin)</li>\r\n                    <li><code>sec</code> (Secretaria)</li>\r\n                    <li><code>doc</code> (Médico)</li>\r\n                </ul>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\app\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\app\\tv\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"E:\\SDMED Sys\\app\\unauthorized\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]